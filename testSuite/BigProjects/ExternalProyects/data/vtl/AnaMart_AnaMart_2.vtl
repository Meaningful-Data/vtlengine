define operator YearMonth(comp component)
  returns component is
    
    substr(cast(comp, string), 1, 7)
    
end operator;
define operator drop_identifier(ds dataset, comp component)
  returns dataset is
  
    max(ds group except comp)
    
end operator;
/*******************************************************************************
*       Module A01
*******************************************************************************/
A01.LE :=
   RIAD_ENTTY
      [filter isnull(HD_OFFC_UNDRT_CD)];
A01.NLE :=
   RIAD_ENTTY
      [filter not isnull(HD_OFFC_UNDRT_CD)];
A01.LE2 :=
   A01.LE
      [rename LGL_FRM to LGL_FRM_LE,
         IS_ANCRDT_RPRTNG to IS_LGL_ENTTY_ANCRDT_CVRD,
         ANNL_TRNVR to ANNL_TRNVR_LE,
         BLNC_SHT_TTL to BLNC_SHT_TTL_LE,
         DT_ENTRPRS_SZ to DT_ENTRPRS_SZ_LE,
         DT_INTTN_LGL_PRCDNGS to DT_INTTN_LGL_PRCDNGS_LE,
         ENTRPRS_SZ to ENTRPRS_SZ_LE,
         LGL_PRCDNG_STTS to LGL_PRCDNG_STTS_LE,
         NMBR_EMPLYS to NMBR_EMPLYS_LE
      ];
A01.LE_3 :=
   A01.LE2
      [calc CNTRY_LE := CNTRY,
         CTY_LE := CTY,
         ECNMC_ACTVTY_LE := ECNMC_ACTVTY,
         ENTTY_RIAD_CD_LE := ENTTY_RIAD_CD,
         INSTTTNL_SCTR_DTL_LE := INSTTTNL_SCTR_DTL,
         INSTTTNL_SCTR_LE := INSTTTNL_SCTR,
         NM_ENTTY_LE := NM_ENTTY,
         PSTL_CD_LE := PSTL_CD,
         STRT_LE := STRT,
         TRRTRL_UNT_LE := TRRTRL_UNT,
         SSMSIGNIFICANCE_LE := SSMSIGNIFICANCE,
         ACCNTNG_FRMWRK_SL_LE := ACCNTNG_FRMWRK_SL
      ];
A01.LE_FLL :=
   A01.LE_3
      [calc IS_LGL_ENTTY_EA_ANCRDT_CVRD := 
            if 
               (CNTRY_LE in anaCreditCountries) 
            then 
               IS_LGL_ENTTY_ANCRDT_CVRD 
            else 
               "F"];
A01.NLE1 :=
   A01.NLE
      [drop HD_OFFC_UNDRT_CD];
A01.NLE2 :=
   A01.NLE1
      [calc identifier HD_OFFC_UNDRT_CD := ENTTY_RIAD_CD];
A01.NLE3 :=
   A01.NLE2
      [aggr 
         IS_LGL_ENTTY_ANCRDT_CVRD := min(IS_ANCRDT_RPRTNG) 
         group by HD_OFFC_UNDRT_CD
      ];
A01.NLE4 :=
   left_join(
      A01.NLE,
      A01.NLE3 
      using HD_OFFC_UNDRT_CD
   );
A01.NLE5 :=
   A01.NLE4
      [calc IS_LGL_ENTTY_EA_ANCRDT_CVRD := 
            if 
               (CNTRY in anaCreditCountries) 
            then 
               IS_LGL_ENTTY_ANCRDT_CVRD 
            else 
               "F"];
A01.LE_FLL2 :=
   A01.LE_FLL
      [drop HD_OFFC_UNDRT_CD];
A01.NLE6 :=
   inner_join(
      A01.NLE5,
      A01.LE_FLL2
         [rename ENTTY_RIAD_CD to HD_OFFC_UNDRT_CD]
         [keep LGL_FRM_LE,
            ANNL_TRNVR_LE,
            BLNC_SHT_TTL_LE,
            DT_ENTRPRS_SZ_LE,
            DT_INTTN_LGL_PRCDNGS_LE,
            ENTRPRS_SZ_LE,
            LGL_PRCDNG_STTS_LE,
            NMBR_EMPLYS_LE,
            CNTRY_LE,
            CTY_LE,
            ECNMC_ACTVTY_LE,
            ENTTY_RIAD_CD_LE,
            INSTTTNL_SCTR_DTL_LE,
            INSTTTNL_SCTR_LE,
            NM_ENTTY_LE,
            PSTL_CD_LE,
            STRT_LE,
            SSMSIGNIFICANCE_LE,
            ACCNTNG_FRMWRK_SL_LE,
            TRRTRL_UNT_LE
         ] as B 
      using DT_RFRNC,HD_OFFC_UNDRT_CD
   );
A01.DBTR :=
   union(A01.NLE6
      [drop LGL_FRM,
         LGL_PRCDNG_STTS,
         DT_INTTN_LGL_PRCDNGS,
         ENTRPRS_SZ,
         DT_ENTRPRS_SZ,
         NMBR_EMPLYS,
         BLNC_SHT_TTL,
         ANNL_TRNVR,
         IS_ANCRDT_RPRTNG
      ],A01.LE_FLL);
A01.ANAMART_ENTTY_LE :=
   left_join(
      A01.DBTR
         [keep IMMDT_PRNT_UNDRT_CD,
            LEI,
            ULTMT_PRNT_UNDRT_CD,
            CNTRY,
            CTY,
            ECNMC_ACTVTY,
            INSTTTNL_SCTR_DTL,
            INSTTTNL_SCTR,
            NM_ENTTY,
            PSTL_CD,
            STRT,
            TRRTRL_UNT,
            CNTRY_LE,
            CTY_LE,
            ECNMC_ACTVTY_LE,
            ENTTY_RIAD_CD_LE,
            INSTTTNL_SCTR_DTL_LE,
            INSTTTNL_SCTR_LE,
            NM_ENTTY_LE,
            PSTL_CD_LE,
            STRT_LE,
            TRRTRL_UNT_LE,
            ANNL_TRNVR_LE,
            BLNC_SHT_TTL_LE,
            DT_ENTRPRS_SZ_LE,
            DT_INTTN_LGL_PRCDNGS_LE,
            ENTRPRS_SZ_LE,
            LGL_FRM_LE,
            LGL_PRCDNG_STTS_LE,
            NMBR_EMPLYS_LE,
            IS_LGL_ENTTY_ANCRDT_CVRD,
            IS_LGL_ENTTY_EA_ANCRDT_CVRD,
            ACCNTNG_FRMWRK_SL,
            ACCNTNG_FRMWRK_SL_LE,
            DT_BRTH,
            SSMSIGNIFICANCE,
            SSMSIGNIFICANCE_LE,
            DT_CLS,
            HD_OFFC_UNDRT_CD
         ] as A,
      RIAD_ENTTY
         [keep GRP_A_ID,
            GRP_A_HD_CD,
            GRP_A_CNTRY,
            GRP_A_HD_NM_ENTTY,
            GRP_A_INSTTTNL_SCTR_DTL,
            GRP_C_ID,
            GRP_C_HD_CD,
            GRP_C_CNTRY,
            GRP_C_HD_NM_ENTTY,
            GRP_C_INSTTTNL_SCTR_DTL,
            GRP_D_ID,
            GRP_D_HD_CD,
            GRP_D_CNTRY,
            GRP_D_HD_NM_ENTTY,
            GRP_D_INSTTTNL_SCTR_DTL
         ] as B
   );
/*******************************************************************************
*       Module A02
*******************************************************************************/
A02.DBTR_FCT_SUM :=
   ANCRDT_INSTRMNT_FCT
      [keep OTSTNDNG_NMNL_AMNT_DV,
         OTSTNDNG_NMNL_AMNT_CV
      ]
      [rename DBTR_ID to ENTTY_RIAD_CD]
      [aggr 
         SUM_OTSTNDNG_NMNL_AMNT_DV := sum(OTSTNDNG_NMNL_AMNT_DV),
         SUM_OTSTNDNG_NMNL_AMNT_CV := sum(OTSTNDNG_NMNL_AMNT_CV) 
         group by DT_RFRNC,ENTTY_RIAD_CD
      ];
A02.DBTR_FCT_NN_PRFRMNG_SUM :=
   ANCRDT_INSTRMNT_FCT
      [filter PRFRMNG_STTS = "1"]
      [keep OTSTNDNG_NMNL_AMNT_DV,
         OTSTNDNG_NMNL_AMNT_CV
      ]
      [rename DBTR_ID to ENTTY_RIAD_CD]
      [aggr 
         SUM_OTSTNDNG_NMNL_AMNT_DV_NN_PRFRMNG := sum(OTSTNDNG_NMNL_AMNT_DV),
         SUM_OTSTNDNG_NMNL_AMNT_CV_NN_PRFRMNG := sum(OTSTNDNG_NMNL_AMNT_CV) 
         group by DT_RFRNC,ENTTY_RIAD_CD
      ];
A02.DBTR_FCT_JN :=
   left_join(
      A02.DBTR_FCT_SUM,
      A02.DBTR_FCT_NN_PRFRMNG_SUM
   );
A02.ANAMART_ENTTY_PRFRMNG :=
   A02.DBTR_FCT_JN
      [calc NN_PRFRMNG_LNS_RT_W_ONA_CV := 
            if 
               SUM_OTSTNDNG_NMNL_AMNT_CV = 0 
            then 
               cast(null,number) 
            else 
               nvl(SUM_OTSTNDNG_NMNL_AMNT_CV_NN_PRFRMNG,0) / SUM_OTSTNDNG_NMNL_AMNT_CV,
         NN_PRFRMNG_LNS_RT_W_ONA_DV := 
            if 
               SUM_OTSTNDNG_NMNL_AMNT_DV = 0 
            then 
               cast(null,number) 
            else 
               nvl(SUM_OTSTNDNG_NMNL_AMNT_DV_NN_PRFRMNG,0) / SUM_OTSTNDNG_NMNL_AMNT_DV
      ]
      [keep NN_PRFRMNG_LNS_RT_W_ONA_CV,
         NN_PRFRMNG_LNS_RT_W_ONA_DV
      ];
/*******************************************************************************
*       Module A03
*******************************************************************************/
A03.DBTR_FCT_DYS :=
   ANCRDT_INSTRMNT_FCT
      [keep RSDL_MTRTY,
         PST_D_DYS,
         OTSTNDNG_NMNL_AMNT_CV
      ]
      [rename DBTR_ID to ENTTY_RIAD_CD];
A03.VRBLS_AGGR :=
   A03.DBTR_FCT_DYS
      [aggr 
         MAX_RSDL_MTRTY_DYS := max(RSDL_MTRTY),
         MAX_PST_D_DYS := max(PST_D_DYS),
         TTL_CV_OTSTNDNG_NMNL_AMNT := sum(OTSTNDNG_NMNL_AMNT_CV) 
         group by DT_RFRNC,ENTTY_RIAD_CD
      ];
A03.RSDL_MRTY_WA :=
   inner_join(
      A03.DBTR_FCT_DYS,
      A03.VRBLS_AGGR 
      aggr 
      RSDL_MTRTY_DYS_WGHTD_AVRG := sum(
         if 
            TTL_CV_OTSTNDNG_NMNL_AMNT = 0 
         then 
            cast(null,number) 
         else 
            RSDL_MTRTY * OTSTNDNG_NMNL_AMNT_CV / TTL_CV_OTSTNDNG_NMNL_AMNT) 
      group by DT_RFRNC,ENTTY_RIAD_CD
   );
A03.ANAMART_ENTTY_DYS :=
   inner_join(
      A03.VRBLS_AGGR,
      A03.RSDL_MRTY_WA
   );
/*******************************************************************************
*       Module A04
*******************************************************************************/
A04.ENTTY_RSK_DFTL :=
   full_join(
      ANCRDT_ENTTY_DFLT_C,
      ANCRDT_ENTTY_RSK_C
   );
A04.ENTTY_RSK_PD :=
   A04.ENTTY_RSK_DFTL
      [keep PD]
      [rename ENTTY_RIAD_CD to DBTR_ID];
A04.ENTTY_RSK_AGG :=
   A04.ENTTY_RSK_PD
      [aggr 
         INDSTRY_PD_SMPL_AVRG := avg(PD),
         INDSTRY_PD_SD := stddev_pop(PD) 
         group by DBTR_ID,DT_RFRNC
      ];
A04.ONA :=
   sum(
         ANCRDT_INSTRMNT_FCT
            [keep OTSTNDNG_NMNL_AMNT_CV] 
         group by OBSRVD_AGNT_CD,DT_RFRNC,DBTR_ID
      );
A04.ENTTY_RSK_ONA :=
   inner_join(
      A04.ENTTY_RSK_PD,
      A04.ONA
   );
A04.DNMNTR :=
   sum(
         A04.ENTTY_RSK_ONA
            [keep OTSTNDNG_NMNL_AMNT_CV]
            [rename OTSTNDNG_NMNL_AMNT_CV to TTL_CV_OTSTNDNG_NMNL_AMNT] 
         group by DT_RFRNC,DBTR_ID
      );
A04.ENTTY_RSK_ONA2 :=
   inner_join(
      A04.ENTTY_RSK_ONA,
      A04.DNMNTR 
      using DT_RFRNC,DBTR_ID
   );
A04.ENTTY_RSK_ONA3 :=
   sum(
         A04.ENTTY_RSK_ONA2
            [calc INDSTRY_PD_WGHTD_AVRG := 
                  if 
                     TTL_CV_OTSTNDNG_NMNL_AMNT = 0 
                  then 
                     cast(null,number) 
                  else 
                     PD * OTSTNDNG_NMNL_AMNT_CV / TTL_CV_OTSTNDNG_NMNL_AMNT]
            [keep INDSTRY_PD_WGHTD_AVRG] 
         group by DT_RFRNC,DBTR_ID
      );
A04.ANAMART_ENTTY_RSK :=
   inner_join(
      A04.ENTTY_RSK_AGG,
      A04.ENTTY_RSK_ONA3 
      rename DBTR_ID to ENTTY_RIAD_CD
   );
/*******************************************************************************
*       Module A05
*******************************************************************************/
A05.DBTR_GGRPHCL :=
   A01.ANAMART_ENTTY_LE
      [keep CNTRY,
         CNTRY_LE
      ];
A05.ANAMART_ENTTY_GGRPHCL_P :=
   A05.DBTR_GGRPHCL
      [calc IS_DMSTC_ACTVTY := 
            if 
               CNTRY = CNTRY_LE 
            then 
               "T" 
            else 
               "F"];
A05.ANAMART_ENTTY_GGRPHCL :=
   A05.ANAMART_ENTTY_GGRPHCL_P
      [calc IS_EA_ACTIVITY := 
            if 
               CNTRY in anaCreditCountries 
            then 
               "T" 
            else 
               "F"]
      [drop CNTRY,
         CNTRY_LE
      ];
/*******************************************************************************
*       Module A06
*******************************************************************************/
A06.ENTTY_INSTRMNT_JN_LBLTS :=
   left_join(
      ANCRDT_ENTTY_INSTRMNT_C,
      ANCRDT_JNT_LBLTS_C 
      using CNTRCT_ID,DT_RFRNC,ENTTY_RIAD_CD,INSTRMNT_ID,OBSRVD_AGNT_CD
   );
A06.ANAMART_ENTTY_P :=
   left_join(
      A01.ANAMART_ENTTY_LE
         [rename IMMDT_PRNT_UNDRT_CD to IMMDT_PRNT_UNDRT_ID,
            ULTMT_PRNT_UNDRT_CD to ULTMT_PRNT_UNDRT_ID,
            HD_OFFC_UNDRT_CD to HD_OFFC_UNDRT_ID
         ] as A,
      A02.ANAMART_ENTTY_PRFRMNG,
      A03.ANAMART_ENTTY_DYS,
      A04.ANAMART_ENTTY_RSK,
      A05.ANAMART_ENTTY_GGRPHCL
   );
A06.SSM_SGNFCNC_P :=
   A06.ANAMART_ENTTY_P
      [calc SSM_SGNFCNC := 
            if 
               isnull(SSMSIGNIFICANCE) 
            then 
               SSMSIGNIFICANCE 
            else 
               0,
         SSM_SGNFCNC_LE := 
            if 
               isnull(SSMSIGNIFICANCE_LE) 
            then 
               SSMSIGNIFICANCE_LE 
            else 
               0
      ]
      [keep SSM_SGNFCNC,
         SSM_SGNFCNC_LE
      ];
A06.ANAMART_INSTRMNT_CRDT_QLTY_2 :=
   B08.ANAMART_INSTRMNT_CRDT_QLTY
      [calc IS_NT_DFLT_DBTR := 
            if 
               DFLT_STTS_DBTR in { 0,14 } 
            then 
               1 
            else 
               0,
         IS_NT_DFLT_INSTRMNT := 
            if 
               DFLT_STTS_INSTRMNT in { 0,14 } 
            then 
               1 
            else 
               0
      ];
A06.ANAMART_INSTRMNT_CRDT_QLTY_MIN_DT_DFLT_DBTR :=
   A06.ANAMART_INSTRMNT_CRDT_QLTY_2
      [filter IS_NT_DFLT_DBTR = 1]
      [aggr 
         MIN_DT_DFLT_DBTR := min(DT_DFLT_STTS_DBTR) 
         group by DT_RFRNC,DBTR_ID
      ];
A06.ANAMART_INSTRMNT_CRDT_QLTY_MIN_DT_DFLT_INSTRMNT :=
   A06.ANAMART_INSTRMNT_CRDT_QLTY_2
      [filter IS_NT_DFLT_INSTRMNT = 1]
      [aggr 
         MIN_DT_DFLT_INSTRMNT := min(DT_DFLT_STTS_INSTRMNT) 
         group by DT_RFRNC,DBTR_ID
      ];
A06.ANAMART_INSTRMNT_CRDT_QLTY_MIN :=
   A06.ANAMART_INSTRMNT_CRDT_QLTY_2
      [aggr 
         MIN_IS_NT_DFLT_DBTR := min(IS_NT_DFLT_DBTR),
         MIN_IS_NT_DFLT_INSTRMNT := min(IS_NT_DFLT_INSTRMNT) 
         group by DT_RFRNC,DBTR_ID
      ];
A06.ANAMART_INSTRMNT_CRDT_QLTY_3 :=
   left_join(
      A06.ANAMART_INSTRMNT_CRDT_QLTY_2,
      A06.ANAMART_INSTRMNT_CRDT_QLTY_MIN,
      A06.ANAMART_INSTRMNT_CRDT_QLTY_MIN_DT_DFLT_DBTR,
      A06.ANAMART_INSTRMNT_CRDT_QLTY_MIN_DT_DFLT_INSTRMNT 
      using DT_RFRNC,DBTR_ID
   );
A06.ANAMART_INSTRMNT_CRDT_QLTY_4 :=
   eval(
      dfltDts(A06.ANAMART_INSTRMNT_CRDT_QLTY_3) 
      language "sqlite" 
      returns dataset { 
         identifier < string > CNTRCT_ID,
         identifier < date > DT_RFRNC,
         identifier < string > DBTR_ID,
         identifier < string > INSTRMNT_ID,
         identifier < string > OBSRVD_AGNT_CD,
         identifier < string > CRDTR_ID,
         measure < string > DFLT_STTS_INSTRMNT,
         measure < date > DT_DFLT_STTS_INSTRMNT,
         measure < string > DFLT_STTS_DBTR,
         measure < date > DT_DFLT_STTS_DBTR,
         measure < number > PD_DBTR,
         measure < integer > IS_NT_DFLT_DBTR,
         measure < integer > IS_NT_DFLT_INSTRMNT,
         measure < integer > MIN_IS_NT_DFLT_DBTR,
         measure < integer > MIN_IS_NT_DFLT_INSTRMNT,
         measure < date > MIN_DT_DFLT_DBTR,
         measure < date > MIN_DT_DFLT_INSTRMNT 
      });
A06.ANAMART_INSTRMNT_CRDT_QLTY_5 :=
   A06.ANAMART_INSTRMNT_CRDT_QLTY_4
      [calc MAX_DT_NT_DFLT_DBTR := 
               max(
                  DT_DFLT_STTS_DBTR over(
                     partition by DT_RFRNC,DBTR_ID 
                     order by DT_DFLT_STTS_DBTR 
                     range between unbounded preceding and 1 preceding 
                  ) 
               ),
         MAX_DT_NT_DFLT_INSTRMNT := 
               max(
                  DT_DFLT_STTS_INSTRMNT over(
                     partition by DT_RFRNC,DBTR_ID 
                     order by DT_DFLT_STTS_INSTRMNT 
                     range between unbounded preceding and 1 preceding 
                  ) 
               )
      ];
A06.ANAMART_INSTRMNT_CRDT_QLTY_6 :=
   A06.ANAMART_INSTRMNT_CRDT_QLTY_5
      [calc LTST_DT_NT_DFLT := 
            if 
               MIN_IS_NT_DFLT_DBTR = 1 
            then 
               DT_RFRNC 
            else 
               MIN_DT_DFLT_DBTR,
         LTST_DT_INSTRMNTS_NT_DFLT := 
            if 
               MIN_IS_NT_DFLT_INSTRMNT = 1 
            then 
               DT_RFRNC 
            else 
               MIN_DT_DFLT_INSTRMNT,
         ERLST_DT_DFLT := 
            if 
               MIN_IS_NT_DFLT_DBTR = 0 
            then 
               MAX_DT_NT_DFLT_DBTR 
            else 
               cast(null,date),
         ERLST_DT_INSTRMNTS_DFLT := 
            if 
               MIN_IS_NT_DFLT_INSTRMNT = 0 
            then 
               MAX_DT_NT_DFLT_INSTRMNT 
            else 
               cast(null,date)
      ];
A06.ANAMART_INSTRMNT_CRDT_QLTY_7 :=
   max(
         A06.ANAMART_INSTRMNT_CRDT_QLTY_6
            [rename DBTR_ID to ENTTY_RIAD_CD]
            [keep LTST_DT_NT_DFLT,
               LTST_DT_INSTRMNTS_NT_DFLT,
               ERLST_DT_DFLT,
               ERLST_DT_INSTRMNTS_DFLT
            ] 
         group by DT_RFRNC,ENTTY_RIAD_CD
      );
A06.ANAMART_ENTTY_IMMDT_PRNT_UNDRT_P_1 :=
   A06.ANAMART_ENTTY_P
      [calc measure TRRTRY_IPU := CNTRY]
      [drop IMMDT_PRNT_UNDRT_ID];
A06.ANAMART_ENTTY_IMMDT_PRNT_UNDRT_P_2 :=
   A06.ANAMART_ENTTY_IMMDT_PRNT_UNDRT_P_1
      [rename ENTTY_RIAD_CD to IMMDT_PRNT_UNDRT_ID,
         CNTRY to CNTRY_IPU,
         ECNMC_ACTVTY to ECNMC_ACTVTY_IPU,
         ENTRPRS_SZ_LE to ENTRPRS_SZ_IPU,
         INSTTTNL_SCTR to INSTTTNL_SCTR_IPU
      ]
      [keep TRRTRY_IPU,
         CNTRY_IPU,
         ECNMC_ACTVTY_IPU,
         ENTRPRS_SZ_IPU,
         INSTTTNL_SCTR_IPU
      ];
A06.ANAMART_ENTTY_IMMDT_PRNT_UNDRT :=
   left_join(
      A06.ANAMART_ENTTY_P
         [keep IMMDT_PRNT_UNDRT_ID] as A,
      A06.ANAMART_ENTTY_IMMDT_PRNT_UNDRT_P_2 
      using DT_RFRNC,IMMDT_PRNT_UNDRT_ID
   );
A06.ANAMART_ENTTY_ULTMT_PRNT_UNDRT_P_1 :=
   A06.ANAMART_ENTTY_P
      [calc measure TRRTRY_UPU := CNTRY]
      [drop ULTMT_PRNT_UNDRT_ID];
A06.ANAMART_ENTTY_ULTMT_PRNT_UNDRT_P_2 :=
   A06.ANAMART_ENTTY_ULTMT_PRNT_UNDRT_P_1
      [rename ENTTY_RIAD_CD to ULTMT_PRNT_UNDRT_ID,
         CNTRY to CNTRY_UPU,
         ECNMC_ACTVTY to ECNMC_ACTVTY_UPU,
         ENTRPRS_SZ_LE to ENTRPRS_SZ_UPU,
         INSTTTNL_SCTR to INSTTTNL_SCTR_UPU
      ]
      [keep TRRTRY_UPU,
         CNTRY_UPU,
         ECNMC_ACTVTY_UPU,
         ENTRPRS_SZ_UPU,
         INSTTTNL_SCTR_UPU
      ];
A06.ANAMART_ENTTY_ULTMT_PRNT_UNDRT :=
   left_join(
      A06.ANAMART_ENTTY_P
         [keep ULTMT_PRNT_UNDRT_ID] as A,
      A06.ANAMART_ENTTY_ULTMT_PRNT_UNDRT_P_2 
      using DT_RFRNC,ULTMT_PRNT_UNDRT_ID
   );
A06.HD_OFFC_UNDRT_P1 :=
   A06.ANAMART_ENTTY_P
      [calc measure HD_OFFC_UNDRT_TRRTRY := CNTRY]
      [drop HD_OFFC_UNDRT_ID];
A06.HD_OFFC_UNDRT_P2 :=
   A06.HD_OFFC_UNDRT_P1
      [rename ENTTY_RIAD_CD to HD_OFFC_UNDRT_ID,
         CNTRY to HD_OFFC_UNDRT_CNTRY,
         ECNMC_ACTVTY to HD_OFFC_UNDRT_ECNMC_ACTVTY,
         ENTRPRS_SZ_LE to HD_OFFC_UNDRT_ENTRPRS_SZ_LE,
         INSTTTNL_SCTR to HD_OFFC_UNDRT_INSTTTNL_SCTR
      ]
      [keep HD_OFFC_UNDRT_TRRTRY,
         HD_OFFC_UNDRT_CNTRY,
         HD_OFFC_UNDRT_ECNMC_ACTVTY,
         HD_OFFC_UNDRT_ENTRPRS_SZ_LE,
         HD_OFFC_UNDRT_INSTTTNL_SCTR
      ];
A06.ANAMART_ENTTY_HD_OFFC_UNDRT :=
   left_join(
      A06.ANAMART_ENTTY_P
         [keep HD_OFFC_UNDRT_ID] as A,
      A06.HD_OFFC_UNDRT_P2 
      using DT_RFRNC,HD_OFFC_UNDRT_ID
   );
A06.ANAMART_ENTTY :=
   inner_join(
      A06.ANAMART_ENTTY_P
         [calc TRRTRY := CNTRY,
            TRRTRY_LE := CNTRY_LE
         ]
         [drop IMMDT_PRNT_UNDRT_ID,
            ULTMT_PRNT_UNDRT_ID,
            HD_OFFC_UNDRT_ID
         ] as A,
      A06.ANAMART_ENTTY_IMMDT_PRNT_UNDRT,
      A06.ANAMART_ENTTY_ULTMT_PRNT_UNDRT,
      A06.ANAMART_ENTTY_HD_OFFC_UNDRT,
      A06.SSM_SGNFCNC_P 
      using DT_RFRNC,ENTTY_RIAD_CD
   );
A06.ANCRDT_CRDTR :=
   inner_join(
      A06.ANAMART_ENTTY
         [drop INDSTRY_PD_SD,
            INDSTRY_PD_SMPL_AVRG,
            INDSTRY_PD_WGHTD_AVRG,
            MAX_PST_D_DYS,
            MAX_RSDL_MTRTY_DYS,
            NN_PRFRMNG_LNS_RT_W_ONA_DV,
            RSDL_MTRTY_DYS_WGHTD_AVRG,
            TTL_CV_OTSTNDNG_NMNL_AMNT
         ] as A,
      drop_identifier(
         drop_identifier(
            drop_identifier(
               A06.ENTTY_INSTRMNT_JN_LBLTS
                  [drop JNT_LBLTY_AMNT]
                  [sub ENTTY_RL = "1"],
               CNTRCT_ID),
            OBSRVD_AGNT_CD),
         INSTRMNT_ID) as B 
      using DT_RFRNC,ENTTY_RIAD_CD
   );
ANCRDT_CRDTR_NN_ANNYMSD_D_1 <-
    A06.ANCRDT_CRDTR;
A06.ANCRDT_DBTR_P :=
   inner_join(
      A06.ANAMART_ENTTY
         [drop ACCNTNG_FRMWRK_SL,
            NN_PRFRMNG_LNS_RT_W_ONA_CV,
            TTL_CV_OTSTNDNG_NMNL_AMNT,
            ACCNTNG_FRMWRK_SL_LE
         ] as A,
      drop_identifier(
         drop_identifier(
            drop_identifier(
               A06.ENTTY_INSTRMNT_JN_LBLTS
                  [drop JNT_LBLTY_AMNT]
                  [sub ENTTY_RL = "2"],
               CNTRCT_ID),
            OBSRVD_AGNT_CD),
         INSTRMNT_ID) as B 
      using DT_RFRNC,ENTTY_RIAD_CD
   );
A06.ANCRDT_DBTR :=
   left_join(
      A06.ANCRDT_DBTR_P,
      A06.ANAMART_INSTRMNT_CRDT_QLTY_7
   );
ANCRDT_DBTR_NN_ANNYMSD_D_1 <-
    A06.ANCRDT_DBTR;
A06.ANCRDT_PRTCTN_PRVDR :=
   inner_join(
      A06.ANAMART_ENTTY
         [drop ACCNTNG_FRMWRK_SL,
            TTL_CV_OTSTNDNG_NMNL_AMNT,
            RSDL_MTRTY_DYS_WGHTD_AVRG,
            MAX_PST_D_DYS,
            MAX_RSDL_MTRTY_DYS,
            NN_PRFRMNG_LNS_RT_W_ONA_CV,
            NN_PRFRMNG_LNS_RT_W_ONA_DV,
            ACCNTNG_FRMWRK_SL_LE
         ] as A,
      drop_identifier(
         drop_identifier(
            drop_identifier(
               A06.ENTTY_INSTRMNT_JN_LBLTS
                  [drop JNT_LBLTY_AMNT]
                  [sub ENTTY_RL = "4"],
               CNTRCT_ID),
            OBSRVD_AGNT_CD),
         INSTRMNT_ID) as B 
      using DT_RFRNC,ENTTY_RIAD_CD
   );
ANCRDT_PRTCTN_PRVDR_NN_ANNYMSD_D_1 <-
    A06.ANCRDT_PRTCTN_PRVDR;
A06.ANCRDT_ORGNTR :=
   inner_join(
      A06.ANAMART_ENTTY
         [drop ACCNTNG_FRMWRK_SL,
            HD_OFFC_UNDRT_CNTRY,
            HD_OFFC_UNDRT_ECNMC_ACTVTY,
            HD_OFFC_UNDRT_ENTRPRS_SZ_LE,
            HD_OFFC_UNDRT_ID,
            HD_OFFC_UNDRT_INSTTTNL_SCTR,
            HD_OFFC_UNDRT_TRRTRY,
            CNTRY_IPU,
            ECNMC_ACTVTY_IPU,
            ENTRPRS_SZ_IPU,
            INSTTTNL_SCTR_IPU,
            TRRTRY_IPU,
            INDSTRY_PD_SD,
            INDSTRY_PD_SMPL_AVRG,
            INDSTRY_PD_WGHTD_AVRG,
            MAX_PST_D_DYS,
            MAX_RSDL_MTRTY_DYS,
            NN_PRFRMNG_LNS_RT_W_ONA_CV,
            NN_PRFRMNG_LNS_RT_W_ONA_DV,
            RSDL_MTRTY_DYS_WGHTD_AVRG,
            TTL_CV_OTSTNDNG_NMNL_AMNT,
            CNTRY_UPU,
            ECNMC_ACTVTY_UPU,
            ENTRPRS_SZ_UPU,
            INSTTTNL_SCTR_UPU,
            TRRTRY_UPU,
            ACCNTNG_FRMWRK_SL_LE
         ] as A,
      drop_identifier(
         drop_identifier(
            drop_identifier(
               A06.ENTTY_INSTRMNT_JN_LBLTS
                  [drop JNT_LBLTY_AMNT]
                  [sub ENTTY_RL = "3"],
               CNTRCT_ID),
            OBSRVD_AGNT_CD),
         INSTRMNT_ID) as B 
      using DT_RFRNC,ENTTY_RIAD_CD
   );
ANCRDT_ORGNTR_NN_ANNYMSD_D_1 <-
    A06.ANCRDT_ORGNTR;
A06.ANCRDT_SRVCR :=
   inner_join(
      A06.ANAMART_ENTTY
         [drop ACCNTNG_FRMWRK_SL,
            HD_OFFC_UNDRT_CNTRY,
            HD_OFFC_UNDRT_ECNMC_ACTVTY,
            HD_OFFC_UNDRT_ENTRPRS_SZ_LE,
            HD_OFFC_UNDRT_ID,
            HD_OFFC_UNDRT_INSTTTNL_SCTR,
            HD_OFFC_UNDRT_TRRTRY,
            CNTRY_IPU,
            ECNMC_ACTVTY_IPU,
            ENTRPRS_SZ_IPU,
            INSTTTNL_SCTR_IPU,
            TRRTRY_IPU,
            INDSTRY_PD_SD,
            INDSTRY_PD_SMPL_AVRG,
            INDSTRY_PD_WGHTD_AVRG,
            MAX_PST_D_DYS,
            MAX_RSDL_MTRTY_DYS,
            NN_PRFRMNG_LNS_RT_W_ONA_CV,
            NN_PRFRMNG_LNS_RT_W_ONA_DV,
            RSDL_MTRTY_DYS_WGHTD_AVRG,
            TTL_CV_OTSTNDNG_NMNL_AMNT,
            CNTRY_UPU,
            ECNMC_ACTVTY_UPU,
            ENTRPRS_SZ_UPU,
            INSTTTNL_SCTR_UPU,
            TRRTRY_UPU,
            ACCNTNG_FRMWRK_SL_LE
         ] as A,
      drop_identifier(
         drop_identifier(
            drop_identifier(
               A06.ENTTY_INSTRMNT_JN_LBLTS
                  [drop JNT_LBLTY_AMNT]
                  [sub ENTTY_RL = "7"],
               CNTRCT_ID),
            OBSRVD_AGNT_CD),
         INSTRMNT_ID) as B 
      using DT_RFRNC,ENTTY_RIAD_CD
   );
ANCRDT_SRVCR_NN_ANNYMSD_D_1 <-
    A06.ANCRDT_SRVCR;
A06.ANCRDT_OBSRVD_AGNT :=
   inner_join(
      A06.ANAMART_ENTTY
         [drop HD_OFFC_UNDRT_CNTRY,
            HD_OFFC_UNDRT_ECNMC_ACTVTY,
            HD_OFFC_UNDRT_ENTRPRS_SZ_LE,
            HD_OFFC_UNDRT_ID,
            HD_OFFC_UNDRT_INSTTTNL_SCTR,
            HD_OFFC_UNDRT_TRRTRY,
            CNTRY_IPU,
            ECNMC_ACTVTY_IPU,
            ENTRPRS_SZ_IPU,
            INSTTTNL_SCTR_IPU,
            TRRTRY_IPU,
            INDSTRY_PD_SD,
            INDSTRY_PD_SMPL_AVRG,
            INDSTRY_PD_WGHTD_AVRG,
            MAX_PST_D_DYS,
            MAX_RSDL_MTRTY_DYS,
            NN_PRFRMNG_LNS_RT_W_ONA_CV,
            NN_PRFRMNG_LNS_RT_W_ONA_DV,
            RSDL_MTRTY_DYS_WGHTD_AVRG,
            TTL_CV_OTSTNDNG_NMNL_AMNT,
            CNTRY_UPU,
            ECNMC_ACTVTY_UPU,
            ENTRPRS_SZ_UPU,
            INSTTTNL_SCTR_UPU,
            TRRTRY_UPU
         ] as A,
      drop_identifier(
         drop_identifier(
            drop_identifier(
               drop_identifier(
                  A06.ENTTY_INSTRMNT_JN_LBLTS
                     [drop JNT_LBLTY_AMNT]
                     [filter ENTTY_RIAD_CD = OBSRVD_AGNT_CD],
                  ENTTY_RL),
               CNTRCT_ID),
            OBSRVD_AGNT_CD),
         INSTRMNT_ID) as B 
      using DT_RFRNC,ENTTY_RIAD_CD
   );
ANCRDT_OBSRVD_AGNT_NN_ANNYMSD_D_1 <-
    A06.ANCRDT_OBSRVD_AGNT;
/*******************************************************************************
*       Module B01
*******************************************************************************/
B01.INSTRMNT_FCT_1 :=
   A06.ENTTY_INSTRMNT_JN_LBLTS
      [filter ENTTY_RL in { "1","2","7" }];
B01.ANCRDT_RPRTNG_ENTTY :=
   RIAD_ENTTY
      [keep IS_ANCRDT_RPRTNG]
      [filter IS_ANCRDT_RPRTNG = "T"];
B01.INSTRMNT_FCT_2 :=
   left_join(
      B01.INSTRMNT_FCT_1,
      B01.ANCRDT_RPRTNG_ENTTY 
      using ENTTY_RIAD_CD,DT_RFRNC
   );
B01.INSTRMNT_FCT_3 :=
   B01.INSTRMNT_FCT_2
      [filter
          ENTTY_RL in { "2","7" } or
            (ENTTY_RL = "1" and
            (isnull(IS_ANCRDT_RPRTNG) or
             ENTTY_RIAD_CD = OBSRVD_AGNT_CD))
      ]
      [drop IS_ANCRDT_RPRTNG];
B01.INSTRMNT_FCT_CRDTR :=
   B01.INSTRMNT_FCT_3
      [rename ENTTY_RIAD_CD to CRDTR_ID]
      [filter ENTTY_RL = "1"];
B01.INSTRMNT_FCT_DBTR :=
   B01.INSTRMNT_FCT_3
      [rename ENTTY_RIAD_CD to DBTR_ID]
      [filter ENTTY_RL = "2"];
B01.INSTRMNT_FCT_4 :=
   eval(
      instrFctJn(B01.INSTRMNT_FCT_CRDTR,B01.INSTRMNT_FCT_DBTR) 
      language "sqlite" 
      returns dataset { 
         identifier < string > CNTRCT_ID,
         identifier < date > DT_RFRNC,
         identifier < string > DBTR_ID,
         identifier < string > INSTRMNT_ID,
         identifier < string > OBSRVD_AGNT_CD,
         measure < number > JNT_LBLTY_AMNT,
         identifier < string > CRDTR_ID 
      });
B01.INSTRMNT_SRVCR_PR :=
   B01.INSTRMNT_FCT_3
      [drop JNT_LBLTY_AMNT]
      [sub ENTTY_RL = "7"]
      [calc RNKNG := 
            if 
               ENTTY_RIAD_CD = OBSRVD_AGNT_CD 
            then 
               1 
            else 
               2]
      [filter RNKNG = 1]
      [drop RNKNG];
B01.INSTRMNT_SRVCR :=
   B01.INSTRMNT_SRVCR_PR
      [calc measure SRVCR_ID := ENTTY_RIAD_CD];
B01.INSTRMNT_SRVCR_MX :=
   max(
         B01.INSTRMNT_SRVCR 
         group except ENTTY_RIAD_CD
      );
B01.ANAMART_INSTRMNT_ACCNTNG_P :=
   left_join(
      ANCRDT_INSTRMNT_C
         [keep DT_INCPTN] as A,
      ANCRDT_ACCNTNG_C
         [keep FRBRNC_STTS]
         [drop FRBRNC_STTS] as B,
      ANCRDT_ACCNTNG_C_Z
         [keep FRBRNC_STTS]
         [rename FRBRNC_STTS to FRBRNC_STTS_Z] as C,
      ANCRDT_ACCNTNG_C_Q
         [keep DT_FRBRNC_STTS,
            FRBRNC_STTS
         ]
         [rename DT_FRBRNC_STTS to DT_FRBRNC_STTS_Q,
            FRBRNC_STTS to FRBRNC_STTS_Q
         ] as D
   );
B01.ANAMART_INSTRMNT_ACCNTNG :=
   B01.ANAMART_INSTRMNT_ACCNTNG_P
      [calc IS_NW_BSNSS := 
            if 
               isnull(FRBRNC_STTS_Q) 
            then 
               cast(null,integer) 
            else 
               if 
                  (YearMonth(
                     DT_INCPTN) = YearMonth(
                     DT_RFRNC) and
                      FRBRNC_STTS_Q not_in { 4 }) or(YearMonth(
                     DT_INCPTN) <> YearMonth(
                     DT_RFRNC) and
                      FRBRNC_STTS_Q <> FRBRNC_STTS_Z and
                   FRBRNC_STTS_Q in { 5,3,9 } and
                      YearMonth(
                     DT_FRBRNC_STTS_Q) = YearMonth(
                     DT_RFRNC)) 
               then 
                  1 
               else 
                  0]
      [keep IS_NW_BSNSS];
B01.ANAMART_INSTRMNT_JN :=
   left_join(
      B01.INSTRMNT_FCT_4,
      ANCRDT_INSTRMNT_C,
      ANCRDT_FNNCL_C
         [rename TRNSFRRD_AMNT to TRNSFRRD_AMNT_INSTRMNT] as F,
      ANCRDT_ACCNTNG_C,
      B01.ANAMART_INSTRMNT_ACCNTNG,
      B01.INSTRMNT_SRVCR_MX 
      using OBSRVD_AGNT_CD,DT_RFRNC,CNTRCT_ID,INSTRMNT_ID 
      keep ACCNTNG_CLSSFCTN,
         ANNLSD_AGRD_RT,
         CRRNCY_DNMNTN,
         DT_END_INTRST_ONLY,
         DT_FRBRNC_STTS,
         DT_INCPTN,
         DT_LGL_FNL_MTRTY,
         DT_NXT_INTRST_RT_RST,
         DT_PRFRMNG_STTS,
         DT_PST_D,
         DT_STTLMNT,
         FDCRY,
         FRBRNC_STTS,
         IMPRMNT_ASSSSMNT_MTHD,
         IMPRMNT_STTS,
         INTRST_RT_CP,
         INTRST_RT_FLR,
         INTRST_RT_RST_FRQNCY,
         INTRST_RT_SPRD,
         IS_NW_BSNSS,
         JNT_LBLTY_AMNT,
         PRDNTL_PRTFL,
         PRFRMNG_STTS,
         PRJCT_FNNC_LN,
         PRPS,
         PYMNT_FRQNCY,
         RCGNTN_STTS,
         RCRS,
         RFRNC_RT,
         RPYMNT_RGHTS,
         SBRDNTD_DBT,
         SRC_ENCMBRNC,
         SYNDCTD_CNTRCT_ID,
         TRNSFRRD_AMNT_INSTRMNT,
         TYP_AMRTSTN,
         TYP_INSTRMNT,
         TYP_INTRST_RT,
         TYP_SCRTSTN,
         SRVCR_ID
   );
/*******************************************************************************
*       Module B02
*******************************************************************************/
B02.LST_DBTRS :=
   B01.INSTRMNT_FCT_3
      [sub ENTTY_RL = "2"];
B02.SHR_ONA_DBTR_AGGR :=
   B02.LST_DBTRS
      [aggr 
         SUM_JNT_LBLTY_AMNT := sum(JNT_LBLTY_AMNT),
         MX_JNT_LBLTY_AMNT := max(JNT_LBLTY_AMNT),
         NMBR_DBTR := count() 
         group by OBSRVD_AGNT_CD,DT_RFRNC,CNTRCT_ID,INSTRMNT_ID
      ];
B02.INSTRMNT_FCT_JNT_LBLTY :=
   inner_join(
      B01.INSTRMNT_FCT_4,
      B02.SHR_ONA_DBTR_AGGR,
      ANCRDT_FNNCL_C
         [keep OTSTNDNG_NMNL_AMNT]
         [rename OTSTNDNG_NMNL_AMNT to OTSTNDNG_NMNL_AMNT_INSTRMNT] as C
   );
B02.JNT_LBLTY_AMNT_ANY_NLL :=
   max(
         B02.LST_DBTRS
            [filter isnull(JNT_LBLTY_AMNT)]
            [calc JNT_LBLTY_AMNT_ANY_NLL := true]
            [keep JNT_LBLTY_AMNT_ANY_NLL] 
         group except ENTTY_RIAD_CD
      );
B02.INSTRMNT_FCT_JNT_LBLTY_FLG :=
   left_join(
      B02.INSTRMNT_FCT_JNT_LBLTY,
      B02.JNT_LBLTY_AMNT_ANY_NLL 
      using DT_RFRNC,OBSRVD_AGNT_CD,CNTRCT_ID,INSTRMNT_ID
   );
B02.ANAMART_INSTRMNT_SHR_ONA_DBTR :=
   B02.INSTRMNT_FCT_JNT_LBLTY_FLG
      [calc SHR_ONA_DBTR_DV := 
            if 
               isnull(OTSTNDNG_NMNL_AMNT_INSTRMNT) 
            then 
               cast(null,number) 
            else 
               if 
                  NMBR_DBTR = 1 
               then 
                  if 
                     isnull(JNT_LBLTY_AMNT) 
                  then 
                     1 
                  else 
                     if 
                        JNT_LBLTY_AMNT > OTSTNDNG_NMNL_AMNT_INSTRMNT 
                     then 
                        cast(null,number) 
                     else 
                        if 
                           JNT_LBLTY_AMNT = 0 and OTSTNDNG_NMNL_AMNT_INSTRMNT = 0 
                        then 
                           0.5 
                        else 
                           JNT_LBLTY_AMNT / OTSTNDNG_NMNL_AMNT_INSTRMNT 
               else 
                  if 
                     JNT_LBLTY_AMNT_ANY_NLL 
                  then 
                     cast(null,number) 
                  else 
                     if 
                        MX_JNT_LBLTY_AMNT > OTSTNDNG_NMNL_AMNT_INSTRMNT 
                     then 
                        cast(null,number) 
                     else 
                        if 
                           SUM_JNT_LBLTY_AMNT = 0 and OTSTNDNG_NMNL_AMNT_INSTRMNT = 0 
                        then 
                           1 / NMBR_DBTR 
                        else 
                           if 
                              SUM_JNT_LBLTY_AMNT = 0 and OTSTNDNG_NMNL_AMNT_INSTRMNT > 0 
                           then 
                              0 
                           else 
                              JNT_LBLTY_AMNT / OTSTNDNG_NMNL_AMNT_INSTRMNT,
         SHR_ONA_DBTR_CV := 
            if 
               isnull(OTSTNDNG_NMNL_AMNT_INSTRMNT) 
            then 
               cast(null,number) 
            else 
               if 
                  NMBR_DBTR = 1 
               then 
                  if 
                     isnull(JNT_LBLTY_AMNT) 
                  then 
                     1 
                  else 
                     if 
                        JNT_LBLTY_AMNT > OTSTNDNG_NMNL_AMNT_INSTRMNT 
                     then 
                        cast(null,number) 
                     else 
                        if 
                           JNT_LBLTY_AMNT = 0 and OTSTNDNG_NMNL_AMNT_INSTRMNT = 0 
                        then 
                           0.5 
                        else 
                           JNT_LBLTY_AMNT / OTSTNDNG_NMNL_AMNT_INSTRMNT 
               else 
                  if 
                     JNT_LBLTY_AMNT_ANY_NLL 
                  then 
                     cast(null,number) 
                  else 
                     if 
                        MX_JNT_LBLTY_AMNT > OTSTNDNG_NMNL_AMNT_INSTRMNT 
                     then 
                        cast(null,number) 
                     else 
                        if 
                           SUM_JNT_LBLTY_AMNT = 0 and OTSTNDNG_NMNL_AMNT_INSTRMNT = 0 
                        then 
                           1 / NMBR_DBTR 
                        else 
                           if 
                              SUM_JNT_LBLTY_AMNT = 0 and OTSTNDNG_NMNL_AMNT_INSTRMNT > 0 
                           then 
                              0 
                           else 
                              if 
                                 SUM_JNT_LBLTY_AMNT > OTSTNDNG_NMNL_AMNT_INSTRMNT 
                              then 
                                 JNT_LBLTY_AMNT / SUM_JNT_LBLTY_AMNT 
                              else 
                                 JNT_LBLTY_AMNT / OTSTNDNG_NMNL_AMNT_INSTRMNT
      ]
      [keep SHR_ONA_DBTR_CV,
         SHR_ONA_DBTR_DV,
         NMBR_DBTR,
         OTSTNDNG_NMNL_AMNT_INSTRMNT
      ];
/*******************************************************************************
*       Module B03
*******************************************************************************/
B03.INSTRMNT_FCT_CRDTR :=
   B01.INSTRMNT_FCT_1
      [filter ENTTY_RL = "1"];
B03.NMBR_CRDTRS_PR_INSTRMNT :=
   B03.INSTRMNT_FCT_CRDTR
      [aggr 
         NMBR_CRDTR := count() 
         group by OBSRVD_AGNT_CD,DT_RFRNC,CNTRCT_ID,INSTRMNT_ID
      ];
B03.NMBR_CRDTRS_PR_INSTRMNT_NT_OA :=
   B03.INSTRMNT_FCT_CRDTR
      [filter ENTTY_RIAD_CD <> OBSRVD_AGNT_CD]
      [aggr 
         NMBR_CRDTRS_NT_OA := count() 
         group by OBSRVD_AGNT_CD,DT_RFRNC,CNTRCT_ID,INSTRMNT_ID
      ];
B03.INSTRMNT_FCT_TRNSFRRD_AMNT :=
   left_join(
      left_join(
         B01.INSTRMNT_FCT_4,
         ANCRDT_FNNCL_C
            [keep OTSTNDNG_NMNL_AMNT,
               TRNSFRRD_AMNT
            ] as B,
         B03.NMBR_CRDTRS_PR_INSTRMNT,
         B03.NMBR_CRDTRS_PR_INSTRMNT_NT_OA 
         using OBSRVD_AGNT_CD,DT_RFRNC,CNTRCT_ID,INSTRMNT_ID
      ) as A,
      RIAD_ENTTY
         [rename ENTTY_RIAD_CD to CRDTR_ID]
         [keep IS_ANCRDT_RPRTNG] as B 
      using DT_RFRNC,CRDTR_ID
   );
B03.ANAMART_INSTRMNT_SHR_ONA_CRDTR :=
   B03.INSTRMNT_FCT_TRNSFRRD_AMNT
      [calc SHR_ONA_CRDTR := 
            if 
               isnull(OTSTNDNG_NMNL_AMNT) or
                   OTSTNDNG_NMNL_AMNT < TRNSFRRD_AMNT or
                  (NMBR_CRDTR = 1 and
                   TRNSFRRD_AMNT > 0 and
                   TRNSFRRD_AMNT < OTSTNDNG_NMNL_AMNT) or
                  (NMBR_CRDTR = NMBR_CRDTRS_NT_OA and
                   TRNSFRRD_AMNT > 0 and
                   TRNSFRRD_AMNT < OTSTNDNG_NMNL_AMNT) or(NMBR_CRDTR > 1 and
                   isnull(TRNSFRRD_AMNT)) 
            then 
               cast(null,number) 
            else 
               if 
                  NMBR_CRDTR = 1 
               then 
                  1 
               else 
                  if 
                     OTSTNDNG_NMNL_AMNT = 0 
                  then 
                     1 / NMBR_CRDTR 
                  else 
                     if 
                        CRDTR_ID = OBSRVD_AGNT_CD 
                     then 
                        (OTSTNDNG_NMNL_AMNT - TRNSFRRD_AMNT) / OTSTNDNG_NMNL_AMNT 
                     else 
                        if 
                           IS_ANCRDT_RPRTNG = "F" 
                        then 
                           if 
                              NMBR_CRDTR > NMBR_CRDTRS_NT_OA 
                           then 
                              if 
                                 NMBR_CRDTRS_NT_OA = 0 
                              then 
                                 cast(null,number) 
                              else 
                                 TRNSFRRD_AMNT /(OTSTNDNG_NMNL_AMNT * NMBR_CRDTRS_NT_OA) 
                           else 
                              1 / NMBR_CRDTR 
                        else 
                           cast(null,number),
         IS_PRPRTNL_ALLCTN_TO_CRDTRS := 
            if 
               CRDTR_ID <> OBSRVD_AGNT_CD and IS_ANCRDT_RPRTNG = "T" 
            then 
               cast(null,string) 
            else 
               if 
                  OTSTNDNG_NMNL_AMNT = 0 
               then 
                  if 
                     NMBR_CRDTR > 1 
                  then 
                     "T" 
                  else 
                     "F" 
               else 
                  if 
                     CRDTR_ID = OBSRVD_AGNT_CD 
                  then 
                     "F" 
                  else 
                     if 
                        NMBR_CRDTRS_NT_OA > 1 
                     then 
                        "T" 
                     else 
                        "F"
      ]
      [keep SHR_ONA_CRDTR,
         IS_PRPRTNL_ALLCTN_TO_CRDTRS
      ];
/*******************************************************************************
*       Module B04
*******************************************************************************/
B04.INSTRMNT_PRTCTN_TTL_INSTRMNT :=
   sum(
         ANCRDT_INSTRMNT_PRTCTN_RCVD_C 
         group by OBSRVD_AGNT_CD,DT_RFRNC,CNTRCT_ID,INSTRMNT_ID
      );
B04.INSTRMNT_FCT_CV_1 :=
   inner_join(
      B02.ANAMART_INSTRMNT_SHR_ONA_DBTR,
      B03.ANAMART_INSTRMNT_SHR_ONA_CRDTR
         [keep SHR_ONA_CRDTR] as C,
      ANCRDT_FNNCL_C
         [keep ARRRS,
            ACCRD_INTRST,
            OFF_BLNC_SHT_AMNT
         ] as D,
      ANCRDT_INSTRMNT_C
         [keep CMMTMNT_INCPTN,
            FV_CHNG_CR_BFR_PRCHS
         ] as E
   );
B04.INSTRMNT_FCT_CV_2 :=
   left_join(
      B04.INSTRMNT_FCT_CV_1,
      B04.INSTRMNT_PRTCTN_TTL_INSTRMNT,
      ANCRDT_ACCNTNG_C
         [keep PRFRMNG_STTS,
            ACCMLTD_WRTFFS,
            ACCMLTD_IMPRMNT,
            ACCMLTD_CHNGS_FV_CR,
            CMLTV_RCVRS_SNC_DFLT,
            CRRYNG_AMNT,
            PRVSNS_OFF_BLNC_SHT
         ] as C 
      using OBSRVD_AGNT_CD,DT_RFRNC,CNTRCT_ID,INSTRMNT_ID
   );
B04.ANAMART_CV :=
   B04.INSTRMNT_FCT_CV_2
      [calc OTSTNDNG_NMNL_AMNT_CV := OTSTNDNG_NMNL_AMNT_INSTRMNT * SHR_ONA_DBTR_CV * SHR_ONA_CRDTR,
         OFF_BLNC_SHT_AMNT_CV := OFF_BLNC_SHT_AMNT * SHR_ONA_DBTR_CV * SHR_ONA_CRDTR,
         CMMTMNT_INCPTN_CV := CMMTMNT_INCPTN * SHR_ONA_DBTR_CV * SHR_ONA_CRDTR,
         ARRRS_CV := ARRRS * SHR_ONA_DBTR_CV * SHR_ONA_CRDTR,
         ACCRD_INTRST_CV := ACCRD_INTRST * SHR_ONA_DBTR_CV * SHR_ONA_CRDTR,
         ACCMLTD_WRTFFS_CV := ACCMLTD_WRTFFS * SHR_ONA_CRDTR * SHR_ONA_DBTR_CV,
         ACCMLTD_IMPRMNT_CV := ACCMLTD_IMPRMNT * SHR_ONA_CRDTR * SHR_ONA_DBTR_CV,
         CHNGS_FV_CR_BFR_PRCHS_CV := 
            if 
               isnull(FV_CHNG_CR_BFR_PRCHS) 
            then 
               cast(null,number) 
            else 
               SHR_ONA_DBTR_DV * SHR_ONA_CRDTR * FV_CHNG_CR_BFR_PRCHS,
         ACCMLTD_CHNGS_FV_CR_CV := ACCMLTD_CHNGS_FV_CR * SHR_ONA_CRDTR * SHR_ONA_DBTR_CV,
         CMLTV_RCVRS_SNC_DFLT_CV := CMLTV_RCVRS_SNC_DFLT * SHR_ONA_CRDTR * SHR_ONA_DBTR_CV,
         CRRYNG_AMNT_CV := CRRYNG_AMNT * SHR_ONA_CRDTR * SHR_ONA_DBTR_CV,
         PRTCTN_ALLCTD_VL_INST_CV := PRTCTN_ALLCTD_VL * SHR_ONA_DBTR_CV * SHR_ONA_CRDTR,
         PRVSNS_OFF_BLNC_SHT_CV := PRVSNS_OFF_BLNC_SHT * SHR_ONA_CRDTR * SHR_ONA_DBTR_CV,
         THRD_PRTY_PRRTY_CLMS_INST_CV := THRD_PRTY_PRRTY_CLMS * SHR_ONA_DBTR_CV * SHR_ONA_CRDTR
      ];
B04.ANAMART_DV :=
   B04.ANAMART_CV
      [calc OTSTNDNG_NMNL_AMNT_DV := OTSTNDNG_NMNL_AMNT_INSTRMNT * SHR_ONA_DBTR_DV * SHR_ONA_CRDTR,
         OFF_BLNC_SHT_AMNT_DV := OFF_BLNC_SHT_AMNT * SHR_ONA_DBTR_DV * SHR_ONA_CRDTR,
         CMMTMNT_INCPTN_DV := CMMTMNT_INCPTN * SHR_ONA_DBTR_DV * SHR_ONA_CRDTR,
         ARRRS_DV := ARRRS * SHR_ONA_DBTR_DV * SHR_ONA_CRDTR,
         ACCRD_INTRST_DV := ACCRD_INTRST * SHR_ONA_DBTR_DV * SHR_ONA_CRDTR,
         ACCMLTD_WRTFFS_DV := ACCMLTD_WRTFFS * SHR_ONA_CRDTR * SHR_ONA_DBTR_DV,
         ACCMLTD_IMPRMNT_DV := ACCMLTD_IMPRMNT * SHR_ONA_CRDTR * SHR_ONA_DBTR_DV,
         CHNGS_FV_CR_BFR_PRCHS_DV := 
            if 
               isnull(FV_CHNG_CR_BFR_PRCHS) 
            then 
               cast(null,number) 
            else 
               SHR_ONA_DBTR_DV * SHR_ONA_CRDTR * FV_CHNG_CR_BFR_PRCHS,
         ACCMLTD_CHNGS_FV_CR_DV := ACCMLTD_CHNGS_FV_CR * SHR_ONA_CRDTR * SHR_ONA_DBTR_DV,
         CMLTV_RCVRS_SNC_DFLT_DV := CMLTV_RCVRS_SNC_DFLT * SHR_ONA_CRDTR * SHR_ONA_DBTR_DV,
         CRRYNG_AMNT_DV := CRRYNG_AMNT * SHR_ONA_CRDTR * SHR_ONA_DBTR_DV,
         PRTCTN_ALLCTD_VL_INST_DV := PRTCTN_ALLCTD_VL * SHR_ONA_DBTR_DV * SHR_ONA_CRDTR,
         PRVSNS_OFF_BLNC_SHT_DV := PRVSNS_OFF_BLNC_SHT * SHR_ONA_CRDTR * SHR_ONA_DBTR_DV,
         THRD_PRTY_PRRTY_CLMS_INST_DV := THRD_PRTY_PRRTY_CLMS * SHR_ONA_DBTR_DV * SHR_ONA_CRDTR
      ];
B04.ANAMART_INSTRMNT_CV_DV :=
   B04.ANAMART_DV
      [keep THRD_PRTY_PRRTY_CLMS_INST_CV,
         ACCMLTD_CHNGS_FV_CR_CV,
         ACCMLTD_IMPRMNT_CV,
         ACCMLTD_WRTFFS_CV,
         ACCRD_INTRST_CV,
         ARRRS_CV,
         CHNGS_FV_CR_BFR_PRCHS_CV,
         CMLTV_RCVRS_SNC_DFLT_CV,
         CMMTMNT_INCPTN_CV,
         CRRYNG_AMNT_CV,
         OFF_BLNC_SHT_AMNT_CV,
         OTSTNDNG_NMNL_AMNT_CV,
         PRTCTN_ALLCTD_VL_INST_CV,
         PRVSNS_OFF_BLNC_SHT_CV,
         THRD_PRTY_PRRTY_CLMS_INST_DV,
         ACCMLTD_CHNGS_FV_CR_DV,
         ACCMLTD_IMPRMNT_DV,
         ACCMLTD_WRTFFS_DV,
         ACCRD_INTRST_DV,
         ARRRS_DV,
         CHNGS_FV_CR_BFR_PRCHS_DV,
         CMLTV_RCVRS_SNC_DFLT_DV,
         CMMTMNT_INCPTN_DV,
         CRRYNG_AMNT_DV,
         OFF_BLNC_SHT_AMNT_DV,
         OTSTNDNG_NMNL_AMNT_DV,
         PRTCTN_ALLCTD_VL_INST_DV,
         PRVSNS_OFF_BLNC_SHT_DV
      ];
/*******************************************************************************
*       Module B05
*******************************************************************************/
B05.INSTRMT_PRTCN_3PSTPC :=
   ANCRDT_INSTRMNT_PRTCTN_RCVD_C
      [aggr 
         V_3PSPC := min(THRD_PRTY_PRRTY_CLMS),
         V_3PTPC := max(THRD_PRTY_PRRTY_CLMS) 
         group by OBSRVD_AGNT_CD,DT_RFRNC,PRTCTN_ID
      ];
B05.INSTRMNT_PRTCTN_3PPC :=
   inner_join(
      ANCRDT_INSTRMNT_PRTCTN_RCVD_C,
      B05.INSTRMT_PRTCN_3PSTPC
   );
B05.INSTRMNT_PRTCTN_3PPC_INSTR :=
   B05.INSTRMNT_PRTCTN_3PPC
      [aggr 
         V_3PSPC := sum(V_3PSPC),
         V_3PTPC := sum(V_3PTPC) 
         group except PRTCTN_ID
      ];
B05.ANAMART_INSTRMNT_3PPC :=
   inner_join(
      B04.ANAMART_INSTRMNT_CV_DV,
      B05.INSTRMNT_PRTCTN_3PPC_INSTR,
      B07.ANAMART_INSTRMNT_X_T_VL
   );
/*******************************************************************************
*       Module B06
*******************************************************************************/
B06.NMBR_CRDTRS_PR_INSTRMNT :=
   A06.ENTTY_INSTRMNT_JN_LBLTS
      [filter ENTTY_RL = "1"]
      [aggr 
         NMBR_CRDTR := count() 
         group by OBSRVD_AGNT_CD,DT_RFRNC,CNTRCT_ID,INSTRMNT_ID
      ];
B06.NMBR_ORGNTRS_PR_INSTRMNT :=
   A06.ENTTY_INSTRMNT_JN_LBLTS
      [filter ENTTY_RL = "3"]
      [aggr 
         NMBR_ORGNTR := count() 
         group by OBSRVD_AGNT_CD,DT_RFRNC,CNTRCT_ID,INSTRMNT_ID
      ];
B06.NMBR_SRVCRS_PR_INSTRMNT :=
   A06.ENTTY_INSTRMNT_JN_LBLTS
      [filter ENTTY_RL = "7"]
      [aggr 
         NMBR_SRVCR := count() 
         group by OBSRVD_AGNT_CD,DT_RFRNC,CNTRCT_ID,INSTRMNT_ID
      ];
B06.NMBR_PRTCTNS_PR_INSTRMNT :=
   ANCRDT_INSTRMNT_PRTCTN_RCVD_C
      [aggr 
         NMBR_PRTCTN := count() 
         group except PRTCTN_ID
      ];
B06.ANAMART_NMBRS_P :=
   left_join(
      B06.NMBR_CRDTRS_PR_INSTRMNT,
      B06.NMBR_ORGNTRS_PR_INSTRMNT,
      B06.NMBR_SRVCRS_PR_INSTRMNT,
      B06.NMBR_PRTCTNS_PR_INSTRMNT
   );
B06.ANAMART_INSTRMNT_NMBRS :=
   nvl(B06.ANAMART_NMBRS_P,0);
/*******************************************************************************
*       Module B07
*******************************************************************************/
B07.APAVI_DS :=
   sum(
         ANCRDT_INSTRMNT_PRTCTN_RCVD_C 
         group except PRTCTN_ID
      );
B07.FNNCL_ZR :=
   ANCRDT_FNNCL_C
      [calc OTSTNDNG_NMNL_AMNT := 
            if 
               isnull(OTSTNDNG_NMNL_AMNT) 
            then 
               cast(null,number) 
            else 
               OTSTNDNG_NMNL_AMNT,
         OFF_BLNC_SHT_AMNT := 
            if 
               isnull(OFF_BLNC_SHT_AMNT) 
            then 
               cast(null,number) 
            else 
               OFF_BLNC_SHT_AMNT
      ];
B07.CTV :=
   B07.FNNCL_ZR
      [calc TTL_CMMTMNT_AMNT := OTSTNDNG_NMNL_AMNT + OFF_BLNC_SHT_AMNT];
B07.XTV_JN :=
   inner_join(
      B07.CTV,
      B03.ANAMART_INSTRMNT_SHR_ONA_CRDTR
         [keep SHR_ONA_CRDTR] as B,
      B07.APAVI_DS
         [rename PRTCTN_ALLCTD_VL to APAVI] as C
   );
B07.ANAMART_INSTRMNT_X_T_VL :=
   B07.XTV_JN
      [calc CTV_INSTRMNT := 
            if 
               APAVI = 0.0 
            then 
               cast(null,number) 
            else 
               TTL_CMMTMNT_AMNT / APAVI,
         LTV_INSTRMNT := 
            if 
               APAVI = 0.0 
            then 
               cast(null,number) 
            else 
               OTSTNDNG_NMNL_AMNT / APAVI,
         LTV_CRDTR := 
            if 
               APAVI = 0.0 
            then 
               cast(null,number) 
            else 
               OTSTNDNG_NMNL_AMNT * SHR_ONA_CRDTR / APAVI
      ]
      [keep CTV_INSTRMNT,
         LTV_INSTRMNT,
         LTV_CRDTR
      ];
/*******************************************************************************
*       Module B08
*******************************************************************************/
B08.FNNCL_R :=
   ANCRDT_FNNCL_C
      [keep DFLT_STTS,
         DT_DFLT_STTS
      ]
      [rename DFLT_STTS to DFLT_STTS_INSTRMNT,
         DT_DFLT_STTS to DT_DFLT_STTS_INSTRMNT
      ];
B08.ENTTY_RSK_R :=
   A04.ENTTY_RSK_DFTL
      [keep DFLT_STTS,
         DT_DFLT_STTS,
         PD
      ]
      [rename ENTTY_RIAD_CD to DBTR_ID,
         DFLT_STTS to DFLT_STTS_DBTR,
         DT_DFLT_STTS to DT_DFLT_STTS_DBTR,
         PD to PD_DBTR
      ];
B08.ANAMART_INSTRMNT_CRDT_QLTY_INSTRMNT :=
   inner_join(
      B01.INSTRMNT_FCT_4
         [drop JNT_LBLTY_AMNT] as A,
      B08.FNNCL_R
   );
B08.ANAMART_INSTRMNT_CRDT_QLTY_P :=
   left_join(
      B08.ANAMART_INSTRMNT_CRDT_QLTY_INSTRMNT,
      B08.ENTTY_RSK_R 
      using DT_RFRNC,OBSRVD_AGNT_CD,DBTR_ID
   );
B08.ANAMART_INSTRMNT_CRDT_QLTY :=
   B08.ANAMART_INSTRMNT_CRDT_QLTY_P
      [calc DT_DFLT_STTS_DBTR := 
            if 
               CRDTR_ID = OBSRVD_AGNT_CD 
            then 
               DT_DFLT_STTS_DBTR 
            else 
               null,
         DFLT_STTS_DBTR := 
            if 
               CRDTR_ID = OBSRVD_AGNT_CD 
            then 
               DFLT_STTS_DBTR 
            else 
               null,
         PD_DBTR := 
            if 
               CRDTR_ID = OBSRVD_AGNT_CD 
            then 
               PD_DBTR 
            else 
               null
      ];
/*******************************************************************************
*       Module B09
*******************************************************************************/
B09.ANAMART_INSTRMNT_DYS_P :=
   B01.ANAMART_INSTRMNT_JN
      [keep DT_END_INTRST_ONLY,
         DT_INCPTN,
         DT_PST_D,
         DT_LGL_FNL_MTRTY,
         DT_NXT_INTRST_RT_RST,
         DT_STTLMNT
      ];
B09.ANAMART_INSTRMNT_DYS :=
   eval(
      instDates(B09.ANAMART_INSTRMNT_DYS_P) 
      language "sqlite" 
      returns dataset { 
         identifier < string > CNTRCT_ID,
         identifier < string > CRDTR_ID,
         identifier < string > DBTR_ID,
         identifier < date > DT_RFRNC,
         identifier < string > INSTRMNT_ID,
         identifier < string > OBSRVD_AGNT_CD,
         measure < integer > NXT_INTRST_RT_RST_DYS,
         measure < integer > ORGNL_MTRTY,
         measure < integer > RSDL_MTRTY,
         measure < integer > PST_D_DYS 
      });
/*******************************************************************************
*       Module B10
*******************************************************************************/
B10.ENTTY_LE :=
   A01.ANAMART_ENTTY_LE
      [keep ENTTY_RIAD_CD_LE];
B10.ENTTY_INSTRMNT_CRDTR_LE :=
   inner_join(
      ANCRDT_ENTTY_INSTRMNT_C
         [sub ENTTY_RL = "1"] as A,
      B10.ENTTY_LE 
      calc identifier LE_CD := ENTTY_RIAD_CD_LE
   );
B10.ENTTY_INSTRMNT_DBTR_LE :=
   inner_join(
      ANCRDT_ENTTY_INSTRMNT_C
         [sub ENTTY_RL = "2"] as A,
      B10.ENTTY_LE 
      calc identifier LE_CD := ENTTY_RIAD_CD_LE
   );
B10.IS_INTRCMPNY_DS :=
   drop_identifier(
         inner_join(
         drop_identifier(
            B10.ENTTY_INSTRMNT_CRDTR_LE
               [drop ENTTY_RIAD_CD_LE],
            ENTTY_RIAD_CD) as A,
         drop_identifier(
            B10.ENTTY_INSTRMNT_DBTR_LE
               [drop ENTTY_RIAD_CD_LE],
            ENTTY_RIAD_CD) as B
      ),
      LE_CD);
B10.IS_SCRD_DS :=
   drop_identifier(
      ANCRDT_INSTRMNT_PRTCTN_RCVD_C,
      PRTCTN_ID)
      [calc IS_SCRD := "T"]
      [keep IS_SCRD];
B10.ORGNTR_ID_DS_P :=
   A06.ENTTY_INSTRMNT_JN_LBLTS
      [filter ENTTY_RL = "3"]
      [calc measure ORGNTR_ID := ENTTY_RIAD_CD];
B10.ORGNTR_ID_DS :=
   min(
         B10.ORGNTR_ID_DS_P 
         group except ENTTY_RIAD_CD,ENTTY_RL
      );
B10.JN_LBLTS_AGGR :=
   A06.ENTTY_INSTRMNT_JN_LBLTS
      [filter ENTTY_RL = "2"]
      [aggr 
         SUM_JNT_LBLTY_AMNT := sum(JNT_LBLTY_AMNT),
         NMBR_DBTRS := count() 
         group except ENTTY_RIAD_CD,ENTTY_RL
      ];
B10.SNGL_LBLTS :=
   B10.JN_LBLTS_AGGR
      [filter NMBR_DBTRS = 1]
      [calc TYP_JNT_LBLTY := "1"]
      [keep TYP_JNT_LBLTY];
B10.MLTPL_DBTRS :=
   inner_join(
      A06.ENTTY_INSTRMNT_JN_LBLTS
         [sub ENTTY_RL = "2"] as A,
      ANCRDT_FNNCL_C
         [keep OTSTNDNG_NMNL_AMNT] as B,
      B10.JN_LBLTS_AGGR
         [filter NMBR_DBTRS > 1]
         [drop NMBR_DBTRS] as C 
      calc IS_ONA_MNR := 
         if 
            JNT_LBLTY_AMNT < OTSTNDNG_NMNL_AMNT 
         then 
            1 
         else 
            0,
      IS_ONA_EQL := 
         if 
            JNT_LBLTY_AMNT = OTSTNDNG_NMNL_AMNT 
         then 
            1 
         else 
            0
   );
B10.MLTPL_DBTRS_ONA_MNR_EQL :=
   min(
         B10.MLTPL_DBTRS 
         group except ENTTY_RIAD_CD
      );
B10.TYP_JNT_LBLTY_MLTPL_DBTRS_P :=
   inner_join(
      B10.JN_LBLTS_AGGR
         [keep SUM_JNT_LBLTY_AMNT] as A,
      ANCRDT_FNNCL_C
         [keep OTSTNDNG_NMNL_AMNT] as B,
      B10.MLTPL_DBTRS_ONA_MNR_EQL
         [keep IS_ONA_MNR,
            IS_ONA_EQL
         ] as C
   );
B10.TYP_JNT_LBLTY_MLTPL_DBTRS :=
   B10.TYP_JNT_LBLTY_MLTPL_DBTRS_P
      [calc TYP_JNT_LBLTY := 
            if 
               SUM_JNT_LBLTY_AMNT = OTSTNDNG_NMNL_AMNT 
            then 
               "2" 
            else 
               if 
                  SUM_JNT_LBLTY_AMNT > OTSTNDNG_NMNL_AMNT and IS_ONA_MNR = 1 
               then 
                  "3" 
               else 
                  if 
                     SUM_JNT_LBLTY_AMNT > OTSTNDNG_NMNL_AMNT and IS_ONA_EQL = 1 
                  then 
                     "4" 
                  else 
                     cast(null,string)]
      [keep TYP_JNT_LBLTY];
B10.TYP_JNT_LBLTY_DS :=
   union(B10.SNGL_LBLTS,B10.TYP_JNT_LBLTY_MLTPL_DBTRS);
B10.ANAMART_INSTRMNT_OTHR :=
   left_join(
      B01.ANAMART_INSTRMNT_JN
         [rename JNT_LBLTY_AMNT to JNT_LBLTY_AMNT_DBTR] as A,
      B10.IS_INTRCMPNY_DS
         [calc IS_INTRCMPNY := "T"] as B,
      B10.IS_SCRD_DS,
      B10.ORGNTR_ID_DS
         [drop JNT_LBLTY_AMNT] as D,
      B10.TYP_JNT_LBLTY_DS 
      using DT_RFRNC,OBSRVD_AGNT_CD,CNTRCT_ID,INSTRMNT_ID 
      calc IS_INTRCMPNY := nvl(IS_INTRCMPNY,"F")
   );
/*******************************************************************************
*       Module B11
*******************************************************************************/
B11.ANAMART_INSTRMNT_JN2_P :=
   left_join(
      B10.ANAMART_INSTRMNT_OTHR,
      B02.ANAMART_INSTRMNT_SHR_ONA_DBTR
         [drop OTSTNDNG_NMNL_AMNT_INSTRMNT] as A,
      B03.ANAMART_INSTRMNT_SHR_ONA_CRDTR,
      B05.ANAMART_INSTRMNT_3PPC
         [drop V_3PSPC,
            V_3PTPC
         ] as B,
      B08.ANAMART_INSTRMNT_CRDT_QLTY,
      B09.ANAMART_INSTRMNT_DYS
   );
B11.ANAMART_INSTRMNT_JN2 :=
   left_join(
      B11.ANAMART_INSTRMNT_JN2_P,
      B06.ANAMART_INSTRMNT_NMBRS 
      using DT_RFRNC,OBSRVD_AGNT_CD,CNTRCT_ID,INSTRMNT_ID
   );
/*******************************************************************************
*       Module B12
*******************************************************************************/
B12.ANAMART_INSTRMNT_INTRVL :=
   B11.ANAMART_INSTRMNT_JN2
      [calc OTSTNDNG_NMNL_AMNT_INTRVL_CV := 
            if 
               isnull(OTSTNDNG_NMNL_AMNT_CV) 
            then 
               cast(null,string) 
            else 
               if 
                  OTSTNDNG_NMNL_AMNT_CV <= 250000 
               then 
                  "2" 
               else 
                  if 
                     OTSTNDNG_NMNL_AMNT_CV <= 1000000 
                  then 
                     "3" 
                  else 
                     "1",
         OTSTNDNG_NMNL_AMNT_INTRVL_DV := 
            if 
               isnull(OTSTNDNG_NMNL_AMNT_DV) 
            then 
               cast(null,string) 
            else 
               if 
                  OTSTNDNG_NMNL_AMNT_DV <= 250000 
               then 
                  "2" 
               else 
                  if 
                     OTSTNDNG_NMNL_AMNT_DV <= 1000000 
                  then 
                     "3" 
                  else 
                     "1",
         NXT_INTRST_RT_RST_INTRVL := 
            if 
               NXT_INTRST_RT_RST_DYS >= 0 
            then 
               if 
                  NXT_INTRST_RT_RST_DYS <= 30 
               then 
                  "72" 
               else 
                  if 
                     NXT_INTRST_RT_RST_DYS <= 30 * 3 
                  then 
                     "9" 
                  else 
                     if 
                        NXT_INTRST_RT_RST_DYS <= 30 * 6 
                     then 
                        "12" 
                     else 
                        if 
                           NXT_INTRST_RT_RST_DYS <= 365 
                        then 
                           "16" 
                        else 
                           if 
                              NXT_INTRST_RT_RST_DYS <= 365 * 2 
                           then 
                              "21" 
                           else 
                              if 
                                 NXT_INTRST_RT_RST_DYS <= 365 * 5 
                              then 
                                 "29" 
                              else 
                                 if 
                                    NXT_INTRST_RT_RST_DYS <= 365 * 10 
                                 then 
                                    "36" 
                                 else 
                                    "71" 
            else 
               cast(null,string),
         ORGNL_MTRTY_INTRVL := 
            if 
               isnull(DT_LGL_FNL_MTRTY) 
            then 
               "70" 
            else 
               if 
                  ORGNL_MTRTY <= 1 
               then 
                  "64" 
               else 
                  if 
                     ORGNL_MTRTY <= 7 
                  then 
                     "3" 
                  else 
                     if 
                        ORGNL_MTRTY <= 30 
                     then 
                        "65" 
                     else 
                        if 
                           ORGNL_MTRTY <= 30 * 3 
                        then 
                           "9" 
                        else 
                           if 
                              ORGNL_MTRTY <= 30 * 6 
                           then 
                              "12" 
                           else 
                              if 
                                 ORGNL_MTRTY <= 365 
                              then 
                                 "16" 
                              else 
                                 if 
                                    ORGNL_MTRTY <= 365 * 1.5 
                                 then 
                                    "66" 
                                 else 
                                    if 
                                       ORGNL_MTRTY <= 365 * 2 
                                    then 
                                       "67" 
                                    else 
                                       if 
                                          ORGNL_MTRTY <= 365 * 3 
                                       then 
                                          "28" 
                                       else 
                                          if 
                                             ORGNL_MTRTY <= 365 * 5 
                                          then 
                                             "31" 
                                          else 
                                             if 
                                                ORGNL_MTRTY <= 365 * 10 
                                             then 
                                                "36" 
                                             else 
                                                if 
                                                   ORGNL_MTRTY <= 365 * 15 
                                                then 
                                                   "39" 
                                                else 
                                                   if 
                                                      ORGNL_MTRTY <= 365 * 20 
                                                   then 
                                                      "41" 
                                                   else 
                                                      if 
                                                         ORGNL_MTRTY <= 365 * 30 
                                                      then 
                                                         "68" 
                                                      else 
                                                         if 
                                                            ORGNL_MTRTY <= 365 * 50 
                                                         then 
                                                            "69" 
                                                         else 
                                                            "70",
         RSDL_MTRTY_INTRVL := 
            if 
               isnull(DT_LGL_FNL_MTRTY) 
            then 
               "70" 
            else 
               if 
                  RSDL_MTRTY <= -365 * 50 
               then 
                  "48" 
               else 
                  if 
                     RSDL_MTRTY <= -365 * 30 
                  then 
                     "49" 
                  else 
                     if 
                        RSDL_MTRTY <= -365 * 20 
                     then 
                        "50" 
                     else 
                        if 
                           RSDL_MTRTY <= -365 * 15 
                        then 
                           "51" 
                        else 
                           if 
                              RSDL_MTRTY <= -365 * 10 
                           then 
                              "52" 
                           else 
                              if 
                                 RSDL_MTRTY <= -365 * 5 
                              then 
                                 "53" 
                              else 
                                 if 
                                    RSDL_MTRTY <= -365 * 3 
                                 then 
                                    "54" 
                                 else 
                                    if 
                                       RSDL_MTRTY <= -365 * 2 
                                    then 
                                       "55" 
                                    else 
                                       if 
                                          RSDL_MTRTY <= -365 * 1.5 
                                       then 
                                          "56" 
                                       else 
                                          if 
                                             RSDL_MTRTY <= -365 
                                          then 
                                             "57" 
                                          else 
                                             if 
                                                RSDL_MTRTY <= -30 * 6 
                                             then 
                                                "58" 
                                             else 
                                                if 
                                                   RSDL_MTRTY <= -30 * 3 
                                                then 
                                                   "59" 
                                                else 
                                                   if 
                                                      RSDL_MTRTY <= -30 
                                                   then 
                                                      "60" 
                                                   else 
                                                      if 
                                                         RSDL_MTRTY <= -7 
                                                      then 
                                                         "61" 
                                                      else 
                                                         if 
                                                            RSDL_MTRTY <= -1 
                                                         then 
                                                            "62" 
                                                         else 
                                                            if 
                                                               RSDL_MTRTY <= 0 
                                                            then 
                                                               "63" 
                                                            else 
                                                               if 
                                                                  RSDL_MTRTY <= 1 
                                                               then 
                                                                  "64" 
                                                               else 
                                                                  if 
                                                                     RSDL_MTRTY <= 7 
                                                                  then 
                                                                     "3" 
                                                                  else 
                                                                     if 
                                                                        RSDL_MTRTY <= 30 
                                                                     then 
                                                                        "65" 
                                                                     else 
                                                                        if 
                                                                           RSDL_MTRTY <= 30 * 3 
                                                                        then 
                                                                           "9" 
                                                                        else 
                                                                           if 
                                                                              RSDL_MTRTY <= 30 * 6 
                                                                           then 
                                                                              "12" 
                                                                           else 
                                                                              if 
                                                                                 RSDL_MTRTY <= 365 
                                                                              then 
                                                                                 "16" 
                                                                              else 
                                                                                 if 
                                                                                    RSDL_MTRTY <= 365 * 1.5 
                                                                                 then 
                                                                                    "66" 
                                                                                 else 
                                                                                    if 
                                                                                       RSDL_MTRTY <= 365 * 2 
                                                                                    then 
                                                                                       "67" 
                                                                                    else 
                                                                                       if 
                                                                                          RSDL_MTRTY <= 365 * 3 
                                                                                       then 
                                                                                          "28" 
                                                                                       else 
                                                                                          if 
                                                                                             RSDL_MTRTY <= 365 * 5 
                                                                                          then 
                                                                                             "31" 
                                                                                          else 
                                                                                             if 
                                                                                                RSDL_MTRTY <= 365 * 10 
                                                                                             then 
                                                                                                "36" 
                                                                                             else 
                                                                                                if 
                                                                                                   RSDL_MTRTY <= 365 * 15 
                                                                                                then 
                                                                                                   "39" 
                                                                                                else 
                                                                                                   if 
                                                                                                      RSDL_MTRTY <= 365 * 20 
                                                                                                   then 
                                                                                                      "41" 
                                                                                                   else 
                                                                                                      if 
                                                                                                         RSDL_MTRTY <= 365 * 30 
                                                                                                      then 
                                                                                                         "68" 
                                                                                                      else 
                                                                                                         if 
                                                                                                            RSDL_MTRTY <= 365 * 50 
                                                                                                         then 
                                                                                                            "69" 
                                                                                                         else 
                                                                                                            "70"
      ];
/*******************************************************************************
*       Module B13
*******************************************************************************/
B13.ANAMART_INSTRMNT_SMPL_WGHT :=
   B12.ANAMART_INSTRMNT_INTRVL
      [calc ANNLSD_AGRD_RT_W_ONA_CV := ANNLSD_AGRD_RT * OTSTNDNG_NMNL_AMNT_CV,
         CTV_INSTRMNT_W_ONA_CV := CTV_INSTRMNT * OTSTNDNG_NMNL_AMNT_CV,
         SHR_ONA_DBTR_CV_W_ONA_CV := SHR_ONA_DBTR_CV * OTSTNDNG_NMNL_AMNT_CV,
         SHR_ONA_DBTR_DV_W_ONA_CV := SHR_ONA_DBTR_DV * OTSTNDNG_NMNL_AMNT_CV,
         INTRST_RT_CP_W_ONA_CV := INTRST_RT_CP * OTSTNDNG_NMNL_AMNT_CV,
         INTRST_RT_FLR_W_ONA_CV := INTRST_RT_FLR * OTSTNDNG_NMNL_AMNT_CV,
         INTRST_RT_SPRD_W_ONA_CV := INTRST_RT_SPRD * OTSTNDNG_NMNL_AMNT_CV,
         LTV_CRDTR_W_ONA_CV := LTV_CRDTR * OTSTNDNG_NMNL_AMNT_CV,
         LTV_INSTRMNT_W_ONA_CV := LTV_INSTRMNT * OTSTNDNG_NMNL_AMNT_CV,
         NMBR_CRDTR_W_ONA_CV := NMBR_CRDTR * OTSTNDNG_NMNL_AMNT_CV,
         NMBR_DBTR_W_ONA_CV := NMBR_DBTR * OTSTNDNG_NMNL_AMNT_CV,
         NMBR_ORGNTR_W_ONA_CV := NMBR_ORGNTR * OTSTNDNG_NMNL_AMNT_CV,
         NMBR_PRTCTN_W_ONA_CV := NMBR_PRTCTN * OTSTNDNG_NMNL_AMNT_CV,
         NMBR_SRVCR_W_ONA_CV := NMBR_SRVCR * OTSTNDNG_NMNL_AMNT_CV,
         NXT_INTRST_RT_RST_DYS_W_ONA_CV := NXT_INTRST_RT_RST_DYS * OTSTNDNG_NMNL_AMNT_CV,
         ORGNL_MTRTY_W_ONA_CV := ORGNL_MTRTY * OTSTNDNG_NMNL_AMNT_CV,
         PD_DBTR_W_ONA_CV := PD_DBTR * OTSTNDNG_NMNL_AMNT_CV,
         PST_D_DYS_W_ONA_CV := PST_D_DYS * OTSTNDNG_NMNL_AMNT_CV,
         RSDL_MTRTY_W_ONA_CV := RSDL_MTRTY * OTSTNDNG_NMNL_AMNT_CV,
         SHR_ONA_CRDTR_W_ONA_CV := SHR_ONA_CRDTR * OTSTNDNG_NMNL_AMNT_CV
      ];
/*******************************************************************************
*       Module B14
*******************************************************************************/
B14.AGG_INCRMNTL :=
   C09.ANAMART_PRTCTN_OTHER
      [aggr 
         INCRMNTL_3PPC := sum(INCRMNTL_3PPC) 
         group by DT_RFRNC,OBSRVD_AGNT_CD,INSTRMNT_ID,CNTRCT_ID,PRTCTN_ID
      ];
B14.SUM_PRTCTN_ALLCTD_VL_DS :=
   ANCRDT_INSTRMNT_PRTCTN_RCVD_C
      [aggr 
         SUM_PRTCTN_ALLCTD_VL := sum(PRTCTN_ALLCTD_VL) 
         group by DT_RFRNC,OBSRVD_AGNT_CD,PRTCTN_ID
      ];
B14.WGHTS_PREP_JN1 :=
   inner_join(
      B14.AGG_INCRMNTL,
      B05.INSTRMNT_PRTCTN_3PPC
         [keep V_3PSPC,
            V_3PTPC,
            PRTCTN_ALLCTD_VL
         ] as B
   );
B14.WGHTS_PREP_JN2 :=
   inner_join(
      B14.WGHTS_PREP_JN1,
      B14.SUM_PRTCTN_ALLCTD_VL_DS
   );
B14.WGHTS_PREP :=
   B14.WGHTS_PREP_JN2
      [calc V_3PSPC_W_3PTPC := 
            if 
               (SUM_PRTCTN_ALLCTD_VL + V_3PTPC) = 0 
            then 
               cast(null,number) 
            else 
               V_3PSPC * INCRMNTL_3PPC /(SUM_PRTCTN_ALLCTD_VL + V_3PTPC),
         V_3PSPC_W_PAV := 
            if 
               (SUM_PRTCTN_ALLCTD_VL + V_3PTPC) = 0 
            then 
               cast(null,number) 
            else 
               V_3PSPC * PRTCTN_ALLCTD_VL /(SUM_PRTCTN_ALLCTD_VL + V_3PTPC),
         V_3PTPC_W_3PTPC := 
            if 
               (SUM_PRTCTN_ALLCTD_VL + V_3PTPC) = 0 
            then 
               cast(null,number) 
            else 
               V_3PTPC * INCRMNTL_3PPC /(SUM_PRTCTN_ALLCTD_VL + V_3PTPC),
         V_3PTPC_W_PAV := 
            if 
               (SUM_PRTCTN_ALLCTD_VL + V_3PTPC) = 0 
            then 
               cast(null,number) 
            else 
               V_3PTPC * PRTCTN_ALLCTD_VL /(SUM_PRTCTN_ALLCTD_VL + V_3PTPC)
      ]
      [drop V_3PSPC,
         V_3PTPC,
         PRTCTN_ALLCTD_VL,
         INCRMNTL_3PPC
      ];
B14.WGHTS_AGGR :=
   sum(
         B14.WGHTS_PREP 
         group by OBSRVD_AGNT_CD,DT_RFRNC,CNTRCT_ID,INSTRMNT_ID
      );
B14.PRTCN_VL_ALLCTN_AGG :=
   sum(
         C04.ANAMART_PRTCTN_PV_ALLCTN 
         group except PRTCTN_ID
      );
B14.WGHTS_JN :=
   inner_join(
      B11.ANAMART_INSTRMNT_JN2
         [keep SHR_ONA_DBTR_DV,
            SHR_ONA_DBTR_CV,
            SHR_ONA_CRDTR
         ] as A,
      B14.WGHTS_AGGR,
      B14.PRTCN_VL_ALLCTN_AGG
   );
B14.ANAMART_INSTRMNT_CMPLX_WGHT_EN :=
   B14.WGHTS_JN
      [calc vv3PSPC_I3PPC_INST_DV := nvl(SHR_ONA_DBTR_DV * SHR_ONA_CRDTR * V_3PSPC_W_3PTPC,0),
         vv3PSPC_PAV_INST_DV := nvl(SHR_ONA_DBTR_DV * SHR_ONA_CRDTR * V_3PSPC_W_PAV,0),
         vv3PTPC_I3PPC_INST_DV := nvl(SHR_ONA_DBTR_DV * SHR_ONA_CRDTR * V_3PTPC_W_3PTPC,0),
         vv3PTPC_PAV_INST_DV := nvl(SHR_ONA_DBTR_DV * SHR_ONA_CRDTR * V_3PTPC_W_PAV,0),
         vv3PSPC_I3PPC_INST_CV := nvl(SHR_ONA_DBTR_CV * SHR_ONA_CRDTR * V_3PSPC_W_3PTPC,0),
         vv3PSPC_PAV_INST_CV := nvl(SHR_ONA_DBTR_CV * SHR_ONA_CRDTR * V_3PSPC_W_PAV,0),
         vv3PTPC_I3PPC_INST_CV := nvl(SHR_ONA_DBTR_CV * SHR_ONA_CRDTR * V_3PTPC_W_3PTPC,0),
         vv3PTPC_PAV_INST_CV := nvl(SHR_ONA_DBTR_CV * SHR_ONA_CRDTR * V_3PTPC_W_PAV,0),
         ORGNL_PRTCTN_VL_I3PPC_INST_DV := nvl(SHR_ONA_DBTR_DV * SHR_ONA_CRDTR * ORGNL_PRTCTN_VL_I3PPC,0),
         ORGNL_PRTCTN_VL_PAV_INST_DV := nvl(SHR_ONA_DBTR_DV * SHR_ONA_CRDTR * ORGNL_PRTCTN_VL_PAV,0),
         PRTCTN_VL_I3PPC_INST_DV := nvl(SHR_ONA_DBTR_DV * SHR_ONA_CRDTR * PRTCTN_VL_I3PPC,0),
         PRTCTN_VL_PAV_INST_DV := nvl(SHR_ONA_DBTR_DV * SHR_ONA_CRDTR * PRTCTN_VL_PAV,0),
         ORGNL_PRTCTN_VL_I3PPC_INST_CV := nvl(SHR_ONA_DBTR_CV * SHR_ONA_CRDTR * ORGNL_PRTCTN_VL_I3PPC,0),
         ORGNL_PRTCTN_VL_PAV_INST_CV := nvl(SHR_ONA_DBTR_CV * SHR_ONA_CRDTR * ORGNL_PRTCTN_VL_PAV,0),
         PRTCTN_VL_I3PPC_INST_CV := nvl(SHR_ONA_DBTR_CV * SHR_ONA_CRDTR * PRTCTN_VL_I3PPC,0),
         PRTCTN_VL_PAV_INST_CV := nvl(SHR_ONA_DBTR_CV * SHR_ONA_CRDTR * PRTCTN_VL_PAV,0)
      ]
      [keep vv3PSPC_I3PPC_INST_DV,
         vv3PSPC_PAV_INST_DV,
         vv3PTPC_I3PPC_INST_DV,
         vv3PTPC_PAV_INST_DV,
         vv3PSPC_I3PPC_INST_CV,
         vv3PSPC_PAV_INST_CV,
         vv3PTPC_I3PPC_INST_CV,
         vv3PTPC_PAV_INST_CV,
         ORGNL_PRTCTN_VL_I3PPC_INST_DV,
         ORGNL_PRTCTN_VL_PAV_INST_DV,
         PRTCTN_VL_I3PPC_INST_DV,
         PRTCTN_VL_PAV_INST_DV,
         ORGNL_PRTCTN_VL_I3PPC_INST_CV,
         ORGNL_PRTCTN_VL_PAV_INST_CV,
         PRTCTN_VL_I3PPC_INST_CV,
         PRTCTN_VL_PAV_INST_CV
      ];
/*******************************************************************************
*       Module B15
*******************************************************************************/
ANCRDT_INSTRMNT_FCT <-
    inner_join(
      B13.ANAMART_INSTRMNT_SMPL_WGHT,
      B14.ANAMART_INSTRMNT_CMPLX_WGHT_EN
   );
/*******************************************************************************
*       Module C01
*******************************************************************************/
C01.ANAMART_PRTCTN_JN :=
   eval(
      prtctnFctJn(ANCRDT_INSTRMNT_PRTCTN_RCVD_C,ANCRDT_PRTCTN_RCVD_C) 
      language "sqlite" 
      returns dataset { 
         identifier < string > OBSRVD_AGNT_CD,
         identifier < string > CNTRCT_ID,
         identifier < date > DT_RFRNC,
         identifier < string > PRTCTN_ID,
         identifier < string > INSTRMNT_ID,
         measure < string > PRTCTN_PRVDR_ID,
         measure < number > PRTCTN_ALLCTD_VL,
         measure < number > THRD_PRTY_PRRTY_CLMS,
         measure < date > DT_PRTCTN_VL,
         measure < date > DT_ORGNL_PRTCTN_VL,
         measure < string > RECL_PSTL_CD,
         measure < string > RL_ESTT_CLLTRL_LCTN,
         measure < string > RECL_TRRTRL_UNT,
         measure < string > PRTCTN_VLTN_APPRCH,
         measure < date > DT_MTRTY_PRTCTN,
         measure < string > TYP_PRTCTN,
         measure < string > RECL_CNTRY,
         measure < string > TYP_PRTCTN_VL,
         measure < number > ORGNL_PRTCTN_VL_PRTCTN,
         measure < number > PRTCTN_VL_PRTN 
      });
/*******************************************************************************
*       Module C02
*******************************************************************************/
C02.PRTCTN_INSTRMNT_FCT :=
   drop_identifier(
      drop_identifier(
         ANCRDT_INSTRMNT_FCT
            [keep SRVCR_ID,
               IS_INTRCMPNY,
               IS_SCRD,
               ORGNTR_ID,
               TYP_JNT_LBLTY,
               NMBR_DBTR,
               CTV_INSTRMNT,
               LTV_INSTRMNT,
               NXT_INTRST_RT_RST_DYS,
               ORGNL_MTRTY,
               RSDL_MTRTY,
               PST_D_DYS,
               NMBR_CRDTR,
               NMBR_ORGNTR,
               NMBR_SRVCR,
               NMBR_PRTCTN,
               NXT_INTRST_RT_RST_INTRVL,
               ORGNL_MTRTY_INTRVL,
               RSDL_MTRTY_INTRVL,
               IS_NW_BSNSS
            ],
         CRDTR_ID),
      DBTR_ID);
C02.PRTCTN_INSTRMNT :=
   ANCRDT_INSTRMNT_C
      [keep CRRNCY_DNMNTN,
         DT_END_INTRST_ONLY,
         DT_INCPTN,
         DT_LGL_FNL_MTRTY,
         DT_STTLMNT,
         FDCRY,
         INTRST_RT_CP,
         INTRST_RT_FLR,
         INTRST_RT_RST_FRQNCY,
         INTRST_RT_SPRD,
         PRJCT_FNNC_LN,
         PRPS,
         PYMNT_FRQNCY,
         RCRS,
         RFRNC_RT,
         RPYMNT_RGHTS,
         SBRDNTD_DBT,
         SYNDCTD_CNTRCT_ID,
         TYP_AMRTSTN,
         TYP_INSTRMNT,
         TYP_INTRST_RT,
         CMMTMNT_INCPTN,
         FV_CHNG_CR_BFR_PRCHS
      ]
      [rename CMMTMNT_INCPTN to CMMTMNT_INCPTN_INSTRMNT,
         FV_CHNG_CR_BFR_PRCHS to FV_CHNG_CR_BFR_PRCHS_INSTRMNT
      ];
C02.PRTCTN_FNNCL :=
   ANCRDT_FNNCL_C
      [keep ANNLSD_AGRD_RT,
         DT_NXT_INTRST_RT_RST,
         DT_PST_D,
         TYP_SCRTSTN,
         TRNSFRRD_AMNT,
         DFLT_STTS,
         DT_DFLT_STTS,
         ACCRD_INTRST,
         ARRRS,
         OTSTNDNG_NMNL_AMNT,
         OFF_BLNC_SHT_AMNT
      ]
      [rename TRNSFRRD_AMNT to TRNSFRRD_AMNT_INSTRMNT,
         DFLT_STTS to DFLT_STTS_INSTRMNT,
         DT_DFLT_STTS to DT_DFLT_STTS_INSTRMNT,
         ACCRD_INTRST to ACCRD_INTRST_INSTRMNT,
         ARRRS to ARRRS_INSTRMNT,
         OTSTNDNG_NMNL_AMNT to OTSTNDNG_NMNL_AMNT_INSTRMNT,
         OFF_BLNC_SHT_AMNT to OFF_BLNC_SHT_AMNT_INSTRMNT
      ];
C02.PRTCTN_ACCNTNG :=
   ANCRDT_ACCNTNG_C
      [keep ACCNTNG_CLSSFCTN,
         DT_FRBRNC_STTS,
         DT_PRFRMNG_STTS,
         FRBRNC_STTS,
         IMPRMNT_ASSSSMNT_MTHD,
         IMPRMNT_STTS,
         PRDNTL_PRTFL,
         PRFRMNG_STTS,
         RCGNTN_STTS,
         SRC_ENCMBRNC,
         ACCMLTD_CHNGS_FV_CR,
         ACCMLTD_IMPRMNT,
         ACCMLTD_WRTFFS,
         CMLTV_RCVRS_SNC_DFLT,
         CRRYNG_AMNT,
         PRVSNS_OFF_BLNC_SHT
      ]
      [rename ACCMLTD_CHNGS_FV_CR to ACCMLTD_CHNGS_FV_CR_INSTRMNT,
         ACCMLTD_IMPRMNT to ACCMLTD_IMPRMNT_INSTRMNT,
         ACCMLTD_WRTFFS to ACCMLTD_WRTFFS_INSTRMNT,
         CMLTV_RCVRS_SNC_DFLT to CMLTV_RCVRS_SNC_DFLT_INSTRMNT,
         CRRYNG_AMNT to CRRYNG_AMNT_INSTRMNT,
         PRVSNS_OFF_BLNC_SHT to PRVSNS_OFF_BLNC_SHT_INSTRMNT
      ];
C02.ANAMART_PRTCTN_INSTRMNT :=
   left_join(
      C01.ANAMART_PRTCTN_JN,
      C02.PRTCTN_INSTRMNT_FCT,
      C02.PRTCTN_INSTRMNT,
      C02.PRTCTN_FNNCL,
      C02.PRTCTN_ACCNTNG 
      using DT_RFRNC,OBSRVD_AGNT_CD,CNTRCT_ID,INSTRMNT_ID
   );
/*******************************************************************************
*       Module C03
*******************************************************************************/
C03.PRTCTN_PAV_AGGR :=
   C04.ANAMART_PRTCTN_PV_ALLCTN
      [aggr 
         ORGNL_PRTCTN_VL_I3PPC_INST := sum(ORGNL_PRTCTN_VL_I3PPC),
         ORGNL_PRTCTN_VL_PAV_INST := sum(ORGNL_PRTCTN_VL_PAV),
         PRTCTN_VL_I3PPC_INST := sum(PRTCTN_VL_I3PPC),
         PRTCTN_VL_PAV_INST := sum(PRTCTN_VL_PAV) 
         group except PRTCTN_ID
      ];
C03.PRTCTN_VL_ALLCTD :=
   ANCRDT_INSTRMNT_PRTCTN_RCVD_C
      [aggr 
         PRTCTN_ALLCTD_VL_INSTRMNT := sum(PRTCTN_ALLCTD_VL) 
         group except PRTCTN_ID
      ];
C03.ANAMART_PRTCTN_AGGR :=
   inner_join(
      C02.ANAMART_PRTCTN_INSTRMNT,
      C03.PRTCTN_PAV_AGGR,
      C03.PRTCTN_VL_ALLCTD
   );
/*******************************************************************************
*       Module C04
*******************************************************************************/
C04.INSTRMTN_PRTCT_RCVD_AGG :=
   ANCRDT_INSTRMNT_PRTCTN_RCVD_C
      [aggr 
         PRTCTN_ALLCTD_VL_PRTCTN := sum(PRTCTN_ALLCTD_VL) 
         group except CNTRCT_ID,INSTRMNT_ID
      ];
C04.INSTRMNT_PRTCTN_ALLCTN_DS :=
   inner_join(
      ANCRDT_INSTRMNT_PRTCTN_RCVD_C
         [keep PRTCTN_ALLCTD_VL] as A,
      ANCRDT_PRTCTN_RCVD_C
         [keep PRTCTN_VL,
            ORGNL_PRTCTN_VL
         ] as B,
      C04.INSTRMTN_PRTCT_RCVD_AGG,
      C09.ANAMART_PRTCTN_OTHER,
      B05.INSTRMT_PRTCN_3PSTPC
   );
C04.ANAMART_PRTCTN_PV_ALLCTN :=
   C04.INSTRMNT_PRTCTN_ALLCTN_DS
      [calc ORGNL_PRTCTN_VL_I3PPC := 
            if 
               (V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN) = 0 
            then 
               0 
            else 
               ORGNL_PRTCTN_VL * INCRMNTL_3PPC /(V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN),
         PRTCTN_VL_I3PPC := 
            if 
               (V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN) = 0 
            then 
               0 
            else 
               PRTCTN_VL * INCRMNTL_3PPC /(V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN),
         ORGNL_PRTCTN_VL_PAV := 
            if 
               (V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN) = 0 
            then 
               0 
            else 
               ORGNL_PRTCTN_VL * PRTCTN_ALLCTD_VL /(V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN),
         PRTCTN_VL_PAV := 
            if 
               (V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN) = 0 
            then 
               PRTCTN_VL / NMBR_INSTRMNT_SCRD 
            else 
               PRTCTN_VL * PRTCTN_ALLCTD_VL /(V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN),
         vv3PSPC_I3PPC := 
            if 
               (V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN) = 0 
            then 
               0 
            else 
               V_3PSPC * INCRMNTL_3PPC /(V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN),
         vv3PSPC_PAV := 
            if 
               (V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN) = 0 
            then 
               0 
            else 
               V_3PSPC * PRTCTN_ALLCTD_VL /(V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN),
         vv3PTPC_I3PPC := 
            if 
               (V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN) = 0 
            then 
               0 
            else 
               V_3PTPC * INCRMNTL_3PPC /(V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN),
         vv3PTPC_PAV := 
            if 
               (V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN) = 0 
            then 
               0 
            else 
               V_3PTPC * PRTCTN_ALLCTD_VL /(V_3PTPC + PRTCTN_ALLCTD_VL_PRTCTN)
      ]
      [keep ORGNL_PRTCTN_VL_I3PPC,
         PRTCTN_VL_I3PPC,
         ORGNL_PRTCTN_VL_PAV,
         PRTCTN_VL_PAV,
         vv3PSPC_I3PPC,
         vv3PSPC_PAV,
         vv3PTPC_I3PPC,
         vv3PTPC_PAV
      ];
/*******************************************************************************
*       Module C05
*******************************************************************************/
C05.ALLCTBL_PRTCN_VL_JN :=
   inner_join(
      ANCRDT_PRTCTN_RCVD_C,
      sum(
            ANCRDT_INSTRMNT_PRTCTN_RCVD_C
               [keep PRTCTN_ALLCTD_VL] 
            group except CNTRCT_ID,INSTRMNT_ID
         ) as B,
      B05.INSTRMT_PRTCN_3PSTPC 
         keep PRTCTN_VL,
            V_3PTPC,
            PRTCTN_ALLCTD_VL
      );
C05.ALLCTBL_PRTCN_VL_DS :=
   C05.ALLCTBL_PRTCN_VL_JN
      [calc ALLCTBL_PRTCTN_VL := PRTCTN_VL - V_3PTPC]
      [calc ALLCTBL_PRTCTN_VL_USD := 
            if 
               ALLCTBL_PRTCTN_VL = 0 
            then 
               0 
            else 
               PRTCTN_ALLCTD_VL / ALLCTBL_PRTCTN_VL]
      [keep ALLCTBL_PRTCTN_VL,
         ALLCTBL_PRTCTN_VL_USD
      ];
C05.ANAMART_PRTCTN_ALLCTBL :=
   inner_join(
      C03.ANAMART_PRTCTN_AGGR,
      C05.ALLCTBL_PRTCN_VL_DS
   );
/*******************************************************************************
*       Module C06
*******************************************************************************/
C06.ENTTY_RSK_R :=
   A04.ENTTY_RSK_DFTL
      [keep DFLT_STTS,
         DT_DFLT_STTS,
         PD
      ]
      [rename ENTTY_RIAD_CD to PRTCTN_PRVDR_ID,
         DFLT_STTS to DFLT_STTS_PRTCTN_PRVDR,
         DT_DFLT_STTS to DT_DFLT_STTS_PRTCTN_PRVDR,
         PD to PD_PRTCTN_PRVDR
      ];
C06.ANAMART_PRTCTN_CRDT_QLTY :=
   left_join(
      C05.ANAMART_PRTCTN_ALLCTBL,
      C06.ENTTY_RSK_R 
      using DT_RFRNC,OBSRVD_AGNT_CD,PRTCTN_PRVDR_ID
   );
/*******************************************************************************
*       Module C07
*******************************************************************************/
C07.MTRSTS_DS :=
   inner_join(
      ANCRDT_INSTRMNT_C
         [keep DT_LGL_FNL_MTRTY,
            NEVS_DT_LGL_FNL_MTRTY
         ] as A,
      ANCRDT_PRTCTN_RCVD_C
         [keep DT_MTRTY_PRTCTN,
            NEVS_DT_MTRTY_PRTCTN
         ] as B,
      ANCRDT_INSTRMNT_PRTCTN_RCVD_C
   );
C07.ANAMART_PRTCTN_MSMTCH :=
   eval(
      prtctnDts(C07.MTRSTS_DS) 
      language "sqlite" 
      returns dataset { 
         identifier < string > CNTRCT_ID,
         identifier < date > DT_RFRNC,
         identifier < string > OBSRVD_AGNT_CD,
         identifier < string > INSTRMNT_ID,
         identifier < string > PRTCTN_ID,
         measure < string > IS_PRTCTN_MTRTY_MSMTCH,
         measure < number > MTRTY_MSMTCH,
         measure < number > PRTCTN_RSDL_MTRTY_DYS 
      });
C07.RSDL_MTRTY_INSTRMNT_MX :=
   C02.ANAMART_PRTCTN_INSTRMNT
      [aggr 
         RSDL_MTRTY_INSTRMNT_MX := max(RSDL_MTRTY) 
         group by DT_RFRNC,OBSRVD_AGNT_CD,PRTCTN_ID
      ];
C07.ANAMART_PRTCTN :=
   inner_join(
      C07.ANAMART_PRTCTN_MSMTCH,
      C07.RSDL_MTRTY_INSTRMNT_MX as B 
      calc PRTCTN_RSDL_MTRTY_DYS := nvl(PRTCTN_RSDL_MTRTY_DYS,RSDL_MTRTY_INSTRMNT_MX) 
      drop RSDL_MTRTY_INSTRMNT_MX
   );
/*******************************************************************************
*       Module C08
*******************************************************************************/
C08.SHR_PV_JN :=
   inner_join(
      inner_join(
         ANCRDT_INSTRMNT_PRTCTN_RCVD_C,
         ANCRDT_INSTRMNT_PRTCTN_RCVD_C
            [aggr 
               PAV_PRTCTN := sum(PRTCTN_ALLCTD_VL) 
               group except CNTRCT_ID,INSTRMNT_ID
            ] as B
      ) as A,
      ANCRDT_INSTRMNT_PRTCTN_RCVD_C
         [aggr 
            PAV_INSTMRNT := sum(PRTCTN_ALLCTD_VL) 
            group except PRTCTN_ID
         ] as B
   );
C08.SHR_PV_DS :=
   C08.SHR_PV_JN
      [calc SHR_PAV_PRTCTN := 
            if 
               PAV_PRTCTN = 0 
            then 
               0 
            else 
               round(PRTCTN_ALLCTD_VL / PAV_PRTCTN,4),
         SHR_PAV_INSTRMNT := 
            if 
               PAV_INSTMRNT = 0 
            then 
               0 
            else 
               round(PRTCTN_ALLCTD_VL / PAV_INSTMRNT,4),
         OTHR_INSTRMNT_PAV_PRTCTN := PAV_PRTCTN - PRTCTN_ALLCTD_VL
      ];
C08.SHR_ONA_CRDTR_IS_ANCRDT_RPRTNG :=
   left_join(
      B03.ANAMART_INSTRMNT_SHR_ONA_CRDTR,
      RIAD_ENTTY
         [keep IS_ANCRDT_RPRTNG]
         [rename ENTTY_RIAD_CD to CRDTR_ID,
            IS_ANCRDT_RPRTNG to IS_CRDTR_ANCRDT_RPRTNG
         ] as B 
      using DT_RFRNC,CRDTR_ID
   );
C08.SHR_ONA_CRDTR_AGG :=
   sum(
         drop_identifier(
            C08.SHR_ONA_CRDTR_IS_ANCRDT_RPRTNG
               [filter
                   CRDTR_ID = OBSRVD_AGNT_CD or
                      IS_CRDTR_ANCRDT_RPRTNG = "F"
               ]
               [keep SHR_ONA_CRDTR],
            DBTR_ID) 
         group except CRDTR_ID
      );
C08.ONA_JN :=
   inner_join(
      C08.SHR_PV_DS
         [keep SHR_PAV_INSTRMNT] as A,
      C08.SHR_ONA_CRDTR_AGG,
      ANCRDT_FNNCL_C
         [keep OTSTNDNG_NMNL_AMNT] as C
   );
C08.ONA_DS :=
   C08.ONA_JN
      [calc OTSTNDNG_NMNL_AMNT_PAV := OTSTNDNG_NMNL_AMNT * SHR_PAV_INSTRMNT * SHR_ONA_CRDTR];
C08.ANAMART_PRTCTN_ALLCTN :=
   left_join(
      C08.SHR_PV_DS
         [keep SHR_PAV_PRTCTN,
            SHR_PAV_INSTRMNT,
            OTHR_INSTRMNT_PAV_PRTCTN
         ] as A,
      C08.ONA_DS
         [keep OTSTNDNG_NMNL_AMNT_PAV] as B 
      calc OTSTNDNG_NMNL_AMNT_PAV := OTSTNDNG_NMNL_AMNT_PAV
   );
/*******************************************************************************
*       Module C09
*******************************************************************************/
C09.INCRMNTL_3PPC_P :=
   ANCRDT_INSTRMNT_PRTCTN_RCVD_C
      [calc MX_3PPC := 
               max(
                  THRD_PRTY_PRRTY_CLMS over(
                     partition by DT_RFRNC,OBSRVD_AGNT_CD,PRTCTN_ID 
                     order by THRD_PRTY_PRRTY_CLMS 
                     range between unbounded preceding and 1 preceding 
                  ) 
               ),
         CNT_3PPC := 
               count(
                  THRD_PRTY_PRRTY_CLMS over(
                     partition by DT_RFRNC,OBSRVD_AGNT_CD,PRTCTN_ID 
                     order by THRD_PRTY_PRRTY_CLMS 
                     range between 0 preceding and 0 following 
                  ) 
               )
      ];
C09.INCRMNTL_3PPC_DS :=
   C09.INCRMNTL_3PPC_P
      [calc INCRMNTL_3PPC :=(THRD_PRTY_PRRTY_CLMS - nvl(MX_3PPC,0)) / nvl(CNT_3PPC,1)];
C09.NMBR_INSTRMNT_SCRD_DS :=
   ANCRDT_INSTRMNT_PRTCTN_RCVD_C
      [aggr 
         NMBR_INSTRMNT_SCRD := count() 
         group by DT_RFRNC,OBSRVD_AGNT_CD,PRTCTN_ID
      ];
C09.ANAMART_PRTCTN_OTHER :=
   inner_join(
      C09.INCRMNTL_3PPC_DS
         [keep INCRMNTL_3PPC] as A,
      C09.NMBR_INSTRMNT_SCRD_DS
   );
/*******************************************************************************
*       Module C10
*******************************************************************************/
C10.ANAMART_PRTCTN_JN2 :=
   inner_join(
      C04.ANAMART_PRTCTN_PV_ALLCTN,
      C06.ANAMART_PRTCTN_CRDT_QLTY,
      C07.ANAMART_PRTCTN,
      C08.ANAMART_PRTCTN_ALLCTN,
      C09.ANAMART_PRTCTN_OTHER
   );
/*******************************************************************************
*       Module C11
*******************************************************************************/
C11.SMPL_WGHT_DS_INSTRMNT :=
   ANCRDT_INSTRMNT_FCT
      [keep CTV_INSTRMNT,
         INTRST_RT_CP,
         INTRST_RT_FLR,
         INTRST_RT_SPRD,
         LTV_INSTRMNT,
         NMBR_CRDTR,
         NMBR_DBTR,
         NMBR_ORGNTR,
         NMBR_SRVCR,
         NXT_INTRST_RT_RST_DYS,
         ORGNL_MTRTY,
         PST_D_DYS,
         RSDL_MTRTY,
         ANNLSD_AGRD_RT
      ];
C11.ANAMART_PRTCTN_SMPL_WGHT_JN :=
   inner_join(
      drop_identifier(
         drop_identifier(
            C11.SMPL_WGHT_DS_INSTRMNT,
            CRDTR_ID),
         DBTR_ID) as A,
      C10.ANAMART_PRTCTN_JN2
         [keep PD_PRTCTN_PRVDR,
            NMBR_INSTRMNT_SCRD,
            SHR_PAV_PRTCTN,
            SHR_PAV_INSTRMNT,
            PRTCTN_RSDL_MTRTY_DYS,
            NMBR_PRTCTN,
            MTRTY_MSMTCH,
            OTSTNDNG_NMNL_AMNT_PAV,
            ALLCTBL_PRTCTN_VL_USD
         ] as B
   );
C11.ANAMART_PRTCTN_SMPL_WGHT_CLC :=
   C11.ANAMART_PRTCTN_SMPL_WGHT_JN
      [calc CTV_INSTRMNT_W_AONA := CTV_INSTRMNT * OTSTNDNG_NMNL_AMNT_PAV,
         INTRST_RT_CP_W_AONA := INTRST_RT_CP * OTSTNDNG_NMNL_AMNT_PAV,
         INTRST_RT_FLR_W_AONA := INTRST_RT_FLR * OTSTNDNG_NMNL_AMNT_PAV,
         INTRST_RT_SPRD_W_AONA := INTRST_RT_SPRD * OTSTNDNG_NMNL_AMNT_PAV,
         LTV_INSTRMNT_W_AONA := LTV_INSTRMNT * OTSTNDNG_NMNL_AMNT_PAV,
         MTRTY_MSMTCH_W_AONA := MTRTY_MSMTCH * OTSTNDNG_NMNL_AMNT_PAV,
         NMBR_CRDTR_W_AONA := NMBR_CRDTR * OTSTNDNG_NMNL_AMNT_PAV,
         NMBR_DBTR_W_AONA := NMBR_DBTR * OTSTNDNG_NMNL_AMNT_PAV,
         NMBR_INSTRMNT_SCRD_W_AONA := NMBR_INSTRMNT_SCRD * OTSTNDNG_NMNL_AMNT_PAV,
         NMBR_ORGNTR_W_AONA := NMBR_ORGNTR * OTSTNDNG_NMNL_AMNT_PAV,
         NMBR_PRTCTN_W_AONA := NMBR_PRTCTN * OTSTNDNG_NMNL_AMNT_PAV,
         NMBR_SRVCR_W_AONA := NMBR_SRVCR * OTSTNDNG_NMNL_AMNT_PAV,
         NXT_INTRST_RT_RST_DYS_W_AONA := NXT_INTRST_RT_RST_DYS * OTSTNDNG_NMNL_AMNT_PAV,
         ORGNL_MTRTY_W_AONA := ORGNL_MTRTY * OTSTNDNG_NMNL_AMNT_PAV,
         PD_PRTCTN_PRVDR_W_AONA := PD_PRTCTN_PRVDR * OTSTNDNG_NMNL_AMNT_PAV,
         PRTCTN_RSDL_MTRTY_DYS_W_AONA := PRTCTN_RSDL_MTRTY_DYS * OTSTNDNG_NMNL_AMNT_PAV,
         PST_D_DYS_W_AONA := PST_D_DYS * OTSTNDNG_NMNL_AMNT_PAV,
         RSDL_MTRTY_W_AONA := RSDL_MTRTY * OTSTNDNG_NMNL_AMNT_PAV,
         SHR_PAV_INSTRMNT_W_AONA := SHR_PAV_INSTRMNT * OTSTNDNG_NMNL_AMNT_PAV,
         SHR_PAV_PRTCTN_W_AONA := SHR_PAV_PRTCTN * OTSTNDNG_NMNL_AMNT_PAV,
         ALLCTBL_PRTCTN_VL_USD_W_AONA := ALLCTBL_PRTCTN_VL_USD * OTSTNDNG_NMNL_AMNT_PAV,
         ANNLSD_AGRD_RT_W_AONA := ANNLSD_AGRD_RT * OTSTNDNG_NMNL_AMNT_PAV
      ]
      [keep CTV_INSTRMNT_W_AONA,
         INTRST_RT_CP_W_AONA,
         INTRST_RT_FLR_W_AONA,
         INTRST_RT_SPRD_W_AONA,
         LTV_INSTRMNT_W_AONA,
         MTRTY_MSMTCH_W_AONA,
         NMBR_CRDTR_W_AONA,
         NMBR_DBTR_W_AONA,
         NMBR_INSTRMNT_SCRD_W_AONA,
         NMBR_ORGNTR_W_AONA,
         NMBR_PRTCTN_W_AONA,
         NMBR_SRVCR_W_AONA,
         NXT_INTRST_RT_RST_DYS_W_AONA,
         ORGNL_MTRTY_W_AONA,
         PD_PRTCTN_PRVDR_W_AONA,
         PRTCTN_RSDL_MTRTY_DYS_W_AONA,
         PST_D_DYS_W_AONA,
         RSDL_MTRTY_W_AONA,
         SHR_PAV_INSTRMNT_W_AONA,
         SHR_PAV_PRTCTN_W_AONA,
         ALLCTBL_PRTCTN_VL_USD_W_AONA,
         ANNLSD_AGRD_RT_W_AONA
      ];
C11.ANAMART_PRTCTN_SMPL_WGHT :=
   inner_join(
      C10.ANAMART_PRTCTN_JN2,
      C11.ANAMART_PRTCTN_SMPL_WGHT_CLC
   );
/*******************************************************************************
*       Module C12
*******************************************************************************/
C12.ANAMART_PRTCTN_SMPL_WGHT_P :=
   C11.ANAMART_PRTCTN_SMPL_WGHT
      [aggr 
         RSDL_MTRTY_MX := max(RSDL_MTRTY) 
         group by DT_RFRNC,OBSRVD_AGNT_CD,PRTCTN_ID
      ];
C12.ANAMART_PRTCTN_SMPL_WGHT_M :=
   left_join(
      C11.ANAMART_PRTCTN_SMPL_WGHT,
      C12.ANAMART_PRTCTN_SMPL_WGHT_P 
      using DT_RFRNC,OBSRVD_AGNT_CD,PRTCTN_ID
   );
C12.ANAMART_PRTCTN_DYS :=
   C12.ANAMART_PRTCTN_SMPL_WGHT_M
      [calc PRTCTN_RSDL_MTRTY := 
            if 
               isnull(DT_MTRTY_PRTCTN) 
            then 
               RSDL_MTRTY_MX 
            else 
               if 
                  PRTCTN_RSDL_MTRTY_DYS <= -365 * 50 
               then 
                  "48" 
               else 
                  if 
                     PRTCTN_RSDL_MTRTY_DYS <= -365 * 30 
                  then 
                     "49" 
                  else 
                     if 
                        PRTCTN_RSDL_MTRTY_DYS <= -365 * 20 
                     then 
                        "50" 
                     else 
                        if 
                           PRTCTN_RSDL_MTRTY_DYS <= -365 * 15 
                        then 
                           "51" 
                        else 
                           if 
                              PRTCTN_RSDL_MTRTY_DYS <= -365 * 10 
                           then 
                              "52" 
                           else 
                              if 
                                 PRTCTN_RSDL_MTRTY_DYS <= -365 * 5 
                              then 
                                 "53" 
                              else 
                                 if 
                                    PRTCTN_RSDL_MTRTY_DYS <= -365 * 3 
                                 then 
                                    "54" 
                                 else 
                                    if 
                                       PRTCTN_RSDL_MTRTY_DYS <= -365 * 2 
                                    then 
                                       "55" 
                                    else 
                                       if 
                                          PRTCTN_RSDL_MTRTY_DYS <= -365 * 1.5 
                                       then 
                                          "56" 
                                       else 
                                          if 
                                             PRTCTN_RSDL_MTRTY_DYS <= -365 
                                          then 
                                             "57" 
                                          else 
                                             if 
                                                PRTCTN_RSDL_MTRTY_DYS <= -30 * 6 
                                             then 
                                                "58" 
                                             else 
                                                if 
                                                   PRTCTN_RSDL_MTRTY_DYS <= -30 * 3 
                                                then 
                                                   "59" 
                                                else 
                                                   if 
                                                      PRTCTN_RSDL_MTRTY_DYS <= -30 
                                                   then 
                                                      "60" 
                                                   else 
                                                      if 
                                                         PRTCTN_RSDL_MTRTY_DYS <= -7 
                                                      then 
                                                         "61" 
                                                      else 
                                                         if 
                                                            PRTCTN_RSDL_MTRTY_DYS <= -1 
                                                         then 
                                                            "62" 
                                                         else 
                                                            if 
                                                               PRTCTN_RSDL_MTRTY_DYS <= 0 
                                                            then 
                                                               "63" 
                                                            else 
                                                               if 
                                                                  PRTCTN_RSDL_MTRTY_DYS <= 1 
                                                               then 
                                                                  "64" 
                                                               else 
                                                                  if 
                                                                     PRTCTN_RSDL_MTRTY_DYS <= 7 
                                                                  then 
                                                                     "3" 
                                                                  else 
                                                                     if 
                                                                        PRTCTN_RSDL_MTRTY_DYS <= 30 
                                                                     then 
                                                                        "65" 
                                                                     else 
                                                                        if 
                                                                           PRTCTN_RSDL_MTRTY_DYS <= 30 * 3 
                                                                        then 
                                                                           "9" 
                                                                        else 
                                                                           if 
                                                                              PRTCTN_RSDL_MTRTY_DYS <= 30 * 6 
                                                                           then 
                                                                              "12" 
                                                                           else 
                                                                              if 
                                                                                 PRTCTN_RSDL_MTRTY_DYS <= 365 
                                                                              then 
                                                                                 "16" 
                                                                              else 
                                                                                 if 
                                                                                    PRTCTN_RSDL_MTRTY_DYS <= 365 * 1.5 
                                                                                 then 
                                                                                    "66" 
                                                                                 else 
                                                                                    if 
                                                                                       PRTCTN_RSDL_MTRTY_DYS <= 365 * 2 
                                                                                    then 
                                                                                       "67" 
                                                                                    else 
                                                                                       if 
                                                                                          PRTCTN_RSDL_MTRTY_DYS <= 365 * 3 
                                                                                       then 
                                                                                          "28" 
                                                                                       else 
                                                                                          if 
                                                                                             PRTCTN_RSDL_MTRTY_DYS <= 365 * 5 
                                                                                          then 
                                                                                             "31" 
                                                                                          else 
                                                                                             if 
                                                                                                PRTCTN_RSDL_MTRTY_DYS <= 365 * 10 
                                                                                             then 
                                                                                                "36" 
                                                                                             else 
                                                                                                if 
                                                                                                   PRTCTN_RSDL_MTRTY_DYS <= 365 * 15 
                                                                                                then 
                                                                                                   "39" 
                                                                                                else 
                                                                                                   if 
                                                                                                      PRTCTN_RSDL_MTRTY_DYS <= 365 * 20 
                                                                                                   then 
                                                                                                      "41" 
                                                                                                   else 
                                                                                                      if 
                                                                                                         PRTCTN_RSDL_MTRTY_DYS <= 365 * 30 
                                                                                                      then 
                                                                                                         "68" 
                                                                                                      else 
                                                                                                         if 
                                                                                                            PRTCTN_RSDL_MTRTY_DYS <= 365 * 50 
                                                                                                         then 
                                                                                                            "69" 
                                                                                                         else 
                                                                                                            "70"];
ANCRDT_PRTCTN_RCVD_FCT <-
    C12.ANAMART_PRTCTN_DYS
      [drop ALLCTBL_PRTCTN_VL,
         RSDL_MTRTY_MX
      ];